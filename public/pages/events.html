<!-- New Event Listener Dialog -->
<div class="modal fade" id="event-listener-new" tabindex="-1" role="dialog" aria-labelledby="event-listener-newLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="event-listener-newLabel">New event listener</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="card">
            <div class="card-header">
              Event
            </div>
            <div class="card-body">
              <div class="form-group">
                <label for="event-listener-new-events-name">Name</label>
                <input class="form-control" type="text" id="event-listener-new-events-name" placeholder="Set name of your event listener (if empty id is set as name)"
                />
              </div>

              <div class="form-group">
                <label for="event-listener-new-events" data-lang="event"></label>
                <select class="form-control" data-load-events="1" id="event-listener-new-events"></select>
              </div>
            </div>
          </div>

          <div class="card" data-event-variables>
            <div class="card-header">
                Usable events variables
            </div>
            <div class="card-body">
              <small></small>
            </div>
          </div>

          <div class="card" data-event-definitions>
            <div class="card-header">
              Settings
            </div>
            <div class="card-body"></div>
          </div>

          <div class="card">
            <div class="card-header">
              Filters
            </div>
            <div class="card-body">
              <textarea class="form-control"></textarea>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <button class="btn btn-outline-primary" onclick="addEventOperation(event)">
                <i class="fa fa-plus" aria-hidden="true"></i>
              </button>
              Operations
            </div>
            <div class="card-body" data-event-operations></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs">
  <li class="nav-item">
    <span data-lang="event-listeners" class="title text-default"></span>
  </li>
  <li class="nav-item">
    <button class="nav-link btn-outline-success plus-button" data-toggle="modal" data-target="#event-listener-new">
      <i class="fa fa-plus" aria-hidden="true"></i> EVENT
    </button>
  </li>
</ul>

<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="viewers">
    <div class="widget">
    </div>
  </div>
</div>

<script>
  var eventsSocket = io('/events', {
    query: "token=" + token
  })

  var supportedEventsList = []
  eventsSocket.emit('list.supported.events', (cb) => {
    supportedEventsList = cb
    console.debug('Loaded list of supported events:', supportedEventsList)
    // load options to event select
    for (let value of _.map(supportedEventsList, 'id')) $('[data-load-events="1"]').append(
      `<option value='${value}'>${translations[value]}</option>`)
    $('[data-load-events]').trigger('change')
  })

  $('[data-load-events="1"]').change((ev) => {
    const event = _.find(supportedEventsList, (o) => o.id === ev.currentTarget.value)
    const variables = _.get(event, 'variables', [])
    const definitions = _.get(event, 'definitions', [])
    console.debug('Event selected', event)

    // VARIABLES ////////////////////////////////////////////////////////////////
    if (variables.length > 0) {
      $('[data-event-variables]').css('display', 'block')
      $('[data-event-variables] small').empty()

      const whatsthis =
        `<a data-events-whats-this class="badge badge-pill badge-light" data-html="true"
                                title="<em>Example of user object data</em>
                                       <br> <b>userObject.id</b>: '123456'
                                       <br> <b>userObject.username</b>: 'exampleuser'
                                       <br> <b>userObject.is.online</b>: true
                                       <br> <b>userObject.is.follower</b>: true <br> <b>userObject.is.regular</b>: true
                                       <br> <b>userObject.is.subscriber</b>: true">
                          what's this?
                        </a>`
      for (let variable of variables) {
        $('[data-event-variables] small').append(
          `
          <div>
            <strong>$${variable}</strong> - ${translations.responses.variable[variable]}
            ${variable === 'userObject'
              ? whatsthis
              : ``}
          </div>
        `
        )

        if (variable === 'userObject') {
          $('[data-events-whats-this]').tooltip()
        }
      }
    } else {
      $('[data-event-variables]').css('display', 'none')
    }
    // !VARIABLES ///////////////////////////////////////////////////////////////

    // DEFINITIONS ////////////////////////////////////////////////////////////
    $('[data-event-definitions] .card-body').empty()
    if (_.size(definitions) > 0) {
      $('[data-event-definitions]').css('display', 'block')
      console.debug('Definitions', definitions)
      for (let [key, value] of Object.entries(definitions))
      {
        $('[data-event-definitions] .card-body').append(`
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text">${translations.events.definitions[key].label}</span>
            </div>
            <input id="definition[${key}]" class="form-control" placeholder="${translations.events.definitions[key].placeholder}" value="${value}">
          </div>
        `)
      }
    } else {
      $('[data-event-definitions]').css('display', 'none')
    }
    // !DEFINITIONS ///////////////////////////////////////////////////////////
  })

  var supportedOperationsList = []
  eventsSocket.emit('list.supported.operations', (cb) => {
    supportedOperationsList = cb
    console.debug('Loaded list of supported operations:', supportedOperationsList)
  })

  // dynamic on change for operations
  $('[data-event-operations]').on('change', 'select', (ev) => {
    const operation = _.find(supportedOperationsList, (o) => o.id === ev.currentTarget.value)
    const definitions = _.get(operation, 'definitions', [])
    console.debug('Operation selected', operation)

    // DEFINITIONS ////////////////////////////////////////////////////////////
    const definitionsElement = $(ev.currentTarget).parents('.operation-group').children('.event-operation-definitions')
    definitionsElement.empty()
    console.debug('Definitions', definitions)
    for (let [key, value] of Object.entries(definitions))
    {
      definitionsElement  .append(`
        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">${translations.events.definitions[key].label}</span>
          </div>
          <input id="definition[${key}]" class="form-control" placeholder="${translations.events.definitions[key].placeholder}" value="${value}">
        </div>
      `)
    }
    // !DEFINITIONS /////////////////////////////////////////////////////////
  });

  // HELPERS //////////////////////////////////////////////////////////////////
  var addEventOperation = (ev) => {
    ev.preventDefault()

    let operationOptions = () => {
      let r = []
      for (let id of _.map(supportedOperationsList, 'id')) r.push(`<option value="${id}">${translations[id]}</option>`)
      return r.join()
    }

    $('[data-event-operations]').append(`
      <div class="operation-group">
        <div class="input-group">
          <select class="form-control">
            ${operationOptions()}
          </select>
          <div class="input-group-append">
            <button class="btn btn-outline-danger" type="button" onclick="removeEventOperation(event, this)">
              <i class="fa fa-minus"></i>
            </button>
          </div>
        </div>
        <div class="event-operation-definitions"></div>
      </div>
    `)
  }

  let removeEventOperation = (ev, self) => {
    ev.preventDefault()
    $(self).parents('.operation-group').remove()
  }

  /*
  socket.emit('events.get');

  $("#quietToggle").on('click', function (ev) {
    ev.preventDefault()
    $el = $(ev.currentTarget)
    if ($el.text() === translations['false']) {
      $el.text(translations['true'])
      $el.removeClass()
      $el.addClass('btn btn-success')
    } else {
      $el.text(translations['false'])
      $el.removeClass()
      $el.addClass('btn btn-danger')
    }
  })

  $('[data-load-events="1"]').on('change', function (ev) {
    $('#commandGroup').css('display', 'none')
    $('#countGroup').css('display', 'none')
    $('#timestampGroup').css('display', 'none')
    $('#usernameInfo').css('display', 'none')
    $('#methodInfo').css('display', 'none')
    $('#monthsInfo').css('display', 'none')
    $('#monthsNameInfo').css('display', 'none')
    $('#messageInfo').css('display', 'none')
    $('#bitsInfo').css('display', 'none')
    $('#reasonInfo').css('display', 'none')
    $('#durationInfo').css('display', 'none')
    $('#durationCommercialInfo').css('display', 'none')
    $('#targetInfo').css('display', 'none')
    $('#viewersInfo').css('display', 'none')
    $('#gameInfo').css('display', 'none')
    $('#oldGameInfo').css('display', 'none')
    $('[data-usable-events="1"]').css('display', 'none')

    $('#command2').val('')
    $('#count').val('')
    $('#timestamp').val('')

    switch (ev.currentTarget.value) {
      case 'user-joined-channel':
      case 'user-parted-channel':
      case 'follow':
      case 'unfollow':
      case 'action':
      case 'mod':
        $('#usernameInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'subscription':
        $('#usernameInfo').css('display', 'block')
        $('#methodInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'commercial':
        $('#durationCommercialInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'resub':
        $('#usernameInfo').css('display', 'block')
        $('#monthsInfo').css('display', 'block')
        $('#monthsNameInfo').css('display', 'block')
        $('#messageInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'cheer':
        $('#usernameInfo').css('display', 'block')
        $('#bitsInfo').css('display', 'block')
        $('#messageInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'ban':
        $('#usernameInfo').css('display', 'block')
        $('#reasonInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'timeout':
        $('#usernameInfo').css('display', 'block')
        $('#reasonInfo').css('display', 'block')
        $('#durationInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'hosting':
        $('#targetInfo').css('display', 'block')
        $('#viewersInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'hosted':
        $('#viewersInfo').css('display', 'block')
        $('#usernameInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'command-send-x-times':
        $('#commandGroup').css('display', 'block')
        $('#countGroup').css('display', 'block')
        $('#count').attr('placeholder', 'commands to activate')
        $('#timestampGroup').css('display', 'block')
        break
      case 'number-of-viewers-is-at-least-x':
        $('#countGroup').css('display', 'block')
        $('#count').attr('placeholder', 'viewers to activate')
        $('#timestampGroup').css('display', 'block')
        break
      case 'stream-is-running-x-minutes':
        $('#countGroup').css('display', 'block')
        $('#count').attr('placeholder', 'minutes to activate')
        break
      case 'every-x-seconds':
        $('#countGroup').css('display', 'block')
        $('#count').attr('placeholder', 'seconds to activate')
        break
      case 'game-changed':
        $('#gameInfo').css('display', 'block')
        $('#oldGameInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
    }
  })

  $('#operations-list').on('change', function (ev) {
    $('#messageGroup').css('display', 'none')
    $('#command2Group').css('display', 'none')
    $('#soundGroup').css('display', 'none')
    $('#emotesGroup').css('display', 'none')
    $('#quietGroup').css('display', 'none')
    $('#commercialGroup').css('display', 'none')

    $('#message').val('')
    $('#sound').val('')
    $('#command2').val('')
    $('#emotes').val('')

    switch (ev.currentTarget.value) {
      case 'send-chat-message':
      case 'send-twitter-message':
      case 'send-whisper':
        $('#messageGroup').css('display', 'block')
        break
      case 'run-command':
        $('#command2Group').css('display', 'block')
        $('#quietGroup').css('display', 'block')
        break
      case 'play-sound':
        $('#soundGroup').css('display', 'block')
        break
      case 'emote-explosion':
        $('#emotesGroup').css('display', 'block')
        break
      case 'start-commercial':
        $('#commercialGroup').css('display', 'block')
        break
    }
  })

  var newEvent = function () {
    let validated = true
    if ($('#commandGroup').css('display') !== 'none') {
      if ($('#command').val().length === 0) {
        $('#commandGroup').addClass('has-error')
        validated = false
      } else {
        $('#commandGroup').removeClass('has-error')
      }
      if (validated && !$('#command').val().startsWith('!')) $('#command').val('!' + $('#command').val()) // add ! if it doesn't start with one
    }

    if ($('#countGroup').css('display') !== 'none' && ($('#count').val().length === 0 || !_.isFinite(parseInt($(
        '#count').val(), 10)))) {
      $('#countGroup').addClass('has-error')
      validated = false
    } else {
      $('#countGroup').removeClass('has-error')
    }

    if ($('#timestampGroup').css('display') !== 'none' && ($('#timestamp').val().length === 0 || !_.isFinite(
        parseInt($('#timestamp').val(), 10)))) {
      $('#timestampGroup').addClass('has-error')
      validated = false
    } else {
      $('#timestampGroup').removeClass('has-error')
    }

    if ($('#messageGroup').css('display') !== 'none' && $('#message').val().length === 0) {
      $('#messageGroup').addClass('has-error')
      validated = false
    } else {
      $('#messageGroup').removeClass('has-error')
    }

    if ($('#command2Group').css('display') !== 'none') {
      if ($('#command2').val().length === 0) {
        $('#command2Group').addClass('has-error')
        validated = false
      } else {
        $('#command2Group').removeClass('has-error')
      }
      if (validated && !$('#command2').val().startsWith('!')) $('#command2').val('!' + $('#command2').val()) // add ! if it doesn't start with one
    }

    if ($('#soundGroup').css('display') !== 'none' && $('#sound').val().length === 0) {
      $('#soundGroup').addClass('has-error')
      validated = false
    } else {
      $('#soundGroup').removeClass('has-error')
    }

    if ($('#emotesGroup').css('display') !== 'none' && $('#emotes').val().length === 0) {
      $('#emotesGroup').addClass('has-error')
      validated = false
    } else {
      $('#emotesGroup').removeClass('has-error')
    }

    if (!validated) {
      return 0
    }

    var data = {
      event: $('#events-list').val(),
      operation: {
        name: $('#operations-list').val(),
        duration: $('#commercial-list').val(),
        send: $('#message').val(),
        sound: $('#sound').val(),
        command: $('#command2').val(),
        emotes: $('#emotes').val(),
        quiet: $('#quietToggle').text() === translations['true'] ? true : false
      },
      definition: {
        command: $('#command').val().length > 0 ? $('#command').val() : null,
        count: $('#count').val().length > 0 ? $('#count').val() : null,
        timestamp: $('#timestamp').val().length > 0 ? $('#timestamp').val() : null
      },
    }

    switch ($('#events-list').val()) {
      case 'user-joined-channel':
      case 'user-parted-channel':
      case 'follow':
      case 'unfollow':
      case 'subscription':
      case 'resub':
      case 'stream-started':
      case 'stream-stopped':
      case 'cheer':
      case 'clearchat':
      case 'action':
      case 'ban':
      case 'hosting':
      case 'hosted':
      case 'mod':
      case 'timeout':
      case 'commercial':
      case 'game-changed':
        delete data.definition
    }
    socket.emit('events.new', data)
    $('#messageGroup').css('display', 'block')
    $('#message').val('')
    $('#soundGroup').css('display', 'none')
    $('#emotesGroup').css('display', 'none')
    $('#command2Group').css('display', 'none')
    $('#quietGroup').css('display', 'none')
    $('#countGroup').css('display', 'none')
    $('#commercialGroup').css('display', 'none')
  }

  socket.off('events')
  socket.on('events', function (data) {
    $('#events-list').empty()
    $('#events-current').empty()
    $('#operations-list').empty()

    _.each(data.events, function (o, k) {
      $('[data-load-events="1"]').append(
        $('<option></option').attr('value', k).text(translations[k]))
      $('[data-load-events="1"]').trigger('change') // manually trigger change to load correct data

      if (o.length) {
        let div_part
        let div_main = $('<div id="' + k + '"></div>')

        div_part = $('<div style="min-width:14%"></div>')
          .append($('<label></label>').text(translations['event']))
          .append($('<div></div>').text(translations[k]))
        div_main.append(div_part)

        let firstDefinition = true
        _.each(o, function (obj) {
          let definition = null
          _.each(obj, function (operation) {
            let div_op = $('<div class="operation" data-event="' + k + '"></div>')
            // is definition
            let div_def
            if (operation.definition) {
              definition = operation
              if (!firstDefinition) {
                div_def = $(
                  '<div class="definition" style="position:relative; left: 200px;"></div>')
              } else {
                div_def = $(
                  '<div class="definition" style="position:absolute; left: 220px;"></div>')
              }
              firstDefinition = false

              if (operation.command) {
                div_part = $(
                    '<div style="min-width:100px;display:block;padding-top:0;" ></div>')
                  .append($('<label></label>').text(translations['command']))
                  .append($('<div style="display:block;"></div>').text(operation.command))
                div_def.append(div_part)
              }
              if (operation.tCount) {
                div_part = $(
                    '<div style="min-width:100px;display:block;padding-top:0;" ></div>')
                  .append($('<label></label>').text(translations['count']))
                  .append($('<div style="display:block;"></div>').text(operation.tCount))
                div_def.append(div_part)
              }
              if (operation.viewers) {
                div_part = $(
                    '<div style="min-width:100px;display:block;padding-top:0;" ></div>')
                  .append($('<label></label>').text(translations['count']))
                  .append($('<div style="display:block;"></div>').text(operation.viewers))
                div_def.append(div_part)
              }
              if (operation.tTimestamp) {
                div_part = $(
                    '<div style="min-width:100px;display:block;padding-top:0;" ></div>')
                  .append($('<label></label>').text(translations['timestamp']))
                  .append($('<div style="display:block"></div>').text(operation.tTimestamp))
                div_def.append(div_part)
              }
              div_main.append(div_def)
            } else {
              div_op.data('name', operation.name)
              div_part = $('<div></div>')
                .append($('<label></label>').text(translations['operation']))
                .append($('<div></div>').text(translations[operation.name]))
              div_op.append(div_part)

              switch (operation.name) {
                case 'send-chat-message':
                case 'send-twitter-message':
                case 'send-whisper':
                  div_op.data('send', operation.send)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text(translations['message']))
                    .append($('<div></div>').text(operation.send))
                  break
                case 'run-command':
                  div_op.data('command', operation.command)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text((operation.quiet ? translations['quiet'] +
                      ' ' : '') + translations['command']))
                    .append($('<div></div>').text(operation.command))
                  break
                case 'play-sound':
                  div_op.data('sound', operation.sound)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text(translations['sound']))
                    .append($('<div></div>').text(operation.sound))
                  break
                case 'emote-explosion':
                  div_op.data('emotes', operation.emotes)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text(translations['emotes']))
                    .append($('<div></div>').text(operation.emotes))
                  break
                case 'start-commercial':
                  div_op.data('duration', operation.duration)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text(translations['duration']))
                    .append($('<div></div>').text(operation.duration + 's'))
                  break
              }

              if (!_.isNil(definition) && _.size(definition) > 1) {
                div_op.data('definition', definition)
              }
              div_op.append(div_part)
              div_main.append(div_op)
            }
          })
        })
        $('#events-current').append(div_main)
      }
    })
    _.each(data.operations, function (o) {
      if (o === 'log') return true
      $('[data-load-operations="1"]').append(
        $('<option></option').attr('value', o).text(translations[o])
      )
    })
  })
*/

</script>
