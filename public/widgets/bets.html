<div class="widget">
    <ul class="nav nav-pills" role="tablist">
      <li role="presentation" class="active">
        <a href="#bets-templates" aria-controls="home" role="tab" data-toggle="tab" title="Betting templates">
          <i class="fa fa-files-o" aria-hidden="true"></i>
        </a>
      </li>
      <li role="presentation">
        <a href="#bets-running" aria-controls="home" role="tab" data-toggle="tab" title="Betting" style="display:none">
          <i class="fa fa-money" aria-hidden="true"></i>
          <span id="betEndTimer"></span>
        </a>
      </li>
      <li role="presentation">
        <a href="#bets-settings" aria-controls="home" role="tab" data-toggle="tab" title="Settings">
          <i class="fa fa-cog" aria-hidden="true"></i>
        </a>
      </li>
    </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="bets-templates">
    </div> <!-- /BETS-TEMPLATES -->

    <div role="tabpanel" class="tab-pane" id="bets-running">
    </div> <!-- /BETS -->

    <div role="tabpanel" class="tab-pane" id="bets-settings">
      <button type="button" class="btn btn-danger btn-block" onclick="deleteWidget('bets')" style="margin-top: 20px;">Remove widget</button>
    </div> <!-- /SETTINGS -->

    <div class="clearfix"></div>
  </div>
</div>

<script>
  var bets = {
    timerEnd: 0,
    updateTimer: function () {
      // update timer
      var timeLeft = bets.timerEnd - new Date().getTime()
      if (timeLeft < 0) {
        $("#betEndTimer").html('CLOSED')
        clearInterval(bets.interval)
      } else {
        var date = new Date(timeLeft)
        var minutes = "0" + date.getMinutes();
        var seconds = "0" + date.getSeconds();
        $("#betEndTimer").text(minutes.substr(-2) + ':' + seconds.substr(-2))
      }
    },
    updateTemplates: function (list) {
      $("#bets-templates").empty()
      _.each(list, function (options) {
        $("#bets-templates").append(
          '<tr>' +
            '<td style="line-height: 30px"><strong>' + options.join(' | ') + '</strong></td>' +
            '<td class="text-right">' +
              '<div class="btn-group" role="group">' +
                '<button type="button" class="btn btn-default" onclick="bets.reuse(this)" data-options="' + options.join(' | ') + '">re-use bet</button>' +
                '<button type="button" onclick="commons.confirm(this)" style="border-top-right-radius:4px; border-bottom-right-radius:4px;" class="btn btn-danger btn-remove"><span class="glyphicon glyphicon-trash"></span></button>' +
                '<button type="button" style="display: none" class="btn btn-success btn-confirm" onclick="bets.remove(this)" data-options="' + options.join(' | ') + '"><span class="glyphicon glyphicon-ok"></span></button>' +
                '<button type="button" style="display: none" class="btn btn-danger btn-confirm" onclick="commons.unconfirm(this)"><span class="glyphicon glyphicon-remove"></span></button>' +
              '</div></td>' +
          '</tr>'
          )
      })
    },
    updateBet: function (bet) {
      var $el = $("#bets-running")
      if (_.isNull(bet)) {
        $el.empty()
        $('a[href="#bets-running"]').css('display', 'none')
        $('a[href="#bets-templates"]').tab('show')
      } else {
        $el.empty()
        bets.timerEnd = bet.timerEnd
        $el.append('<div class="text-center">')
        var btns = []
        btns.push('<div class="btn-group" role="group">')
        _.each(bet.bets, function (value, index) {
          btns.push('<button onclick="bets.close(this)" data-option="' + index + '" type="button" class="btn btn-default">' + index + '</button>')
        })
        btns.push('<button onclick="bets.close(this)" data-option="refund" type="button" class="btn btn-danger">refund</button>')
        btns.push('</div>')
        $el.append(btns.join(''))
        $el.append('</div>')

        bets.updateTimer()
        bets.interval = setInterval(function () { bets.updateTimer() }, 1000)
      }
    },
    close: function (el) {
      socket.emit('closeBet', el.dataset.option)
      $("#betEndTimer").empty()
      $('a[href="#bets-running"]').css('display', 'none')
      $('a[href="#bets-templates"]').tab('show')
      clearInterval(bets.interval)
    },
    reuse: function (el) {
      socket.emit('reuseBet', el.dataset.options.split(' | '))
      $('a[href="#bets-running"]').css('display', 'block')
      $('a[href="#bets-running"]').tab('show')
    },
    remove: function (el) {
      socket.emit('removeBetTemplate', el.dataset.options.split(' | '))
    },
    interval: null
  }

  socket.emit('getBetsTemplates');
  socket.emit('getRunningBet');

  socket.off('betsTemplates')
  socket.on('betsTemplates', function (list) { bets.updateTemplates(list) })

  socket.off('runningBet')
  socket.on('runningBet', function (bet) { bets.updateBet(bet) })
</script>