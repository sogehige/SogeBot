<!-- New Event Listener Dialog -->
<div class="modal fade" id="event-listener-new" tabindex="-1" role="dialog" aria-labelledby="event-listener-newLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="event-listener-newLabel">New event listener</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="event-form">
          <div class="card">
            <div class="card-header">
              Event
            </div>
            <div class="card-body">
              <div class="form-group">
                <label for="event-listener-new-events-name">Name</label>
                <input class="form-control" type="text" id="event-listener-new-events-name" placeholder="Set name of your event listener (if empty id is set as name)"
                />
              </div>

              <div class="form-group">
                <label for="event-listener-new-events" data-lang="event"></label>
                <select class="form-control" data-load-events="1" id="event-listener-new-events"></select>
              </div>
            </div>
          </div>

          <div class="card" data-event-variables>
            <div class="card-header">
                Usable events variables
            </div>
            <div class="card-body">
              <small></small>
            </div>
          </div>

          <div class="card" data-event-definitions>
            <div class="card-header">
              Settings
            </div>
            <div class="card-body"></div>
          </div>

          <div class="card">
            <div class="card-header">
              Filters
            </div>
            <div class="card-body">
              <textarea id="event-listener-filter" class="form-control"></textarea>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <button class="btn btn-outline-primary" onclick="addEventOperation(event)">
                <i class="fa fa-plus" aria-hidden="true"></i>
              </button>
              Operations
            </div>
            <div class="card-body" data-event-operations></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="saveChanges(event)">Save changes</button>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs">
  <li class="nav-item">
    <span data-lang="event-listeners" class="title text-default"></span>
  </li>
  <li class="nav-item">
    <button class="nav-link btn-outline-success plus-button" data-toggle="modal" data-target="#event-listener-new">
      <i class="fa fa-plus" aria-hidden="true"></i> EVENT
    </button>
  </li>
</ul>

<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="viewers">
    <div class="widget">
    </div>
  </div>
</div>

<script>
  var eventsSocket = io('/events', {
    query: "token=" + token
  })

  var supportedEventsList = []
  eventsSocket.emit('list.supported.events', (cb) => {
    supportedEventsList = cb
    console.debug('Loaded list of supported events:', supportedEventsList)
    // load options to event select
    for (let value of _.map(supportedEventsList, 'id')) $('[data-load-events="1"]').append(
      `<option value='${value}'>${translations[value]}</option>`)
    $('[data-load-events]').trigger('change')
  })

  $('[data-load-events="1"]').change((ev) => {
    const event = _.find(supportedEventsList, (o) => o.id === ev.currentTarget.value)
    const variables = _.get(event, 'variables', [])
    const definitions = _.get(event, 'definitions', [])
    console.debug('Event selected', event)

    // VARIABLES ////////////////////////////////////////////////////////////////
    if (variables.length > 0) {
      $('[data-event-variables]').css('display', 'block')
      $('[data-event-variables] small').empty()

      const whatsthis =
        `<a data-events-whats-this class="badge badge-pill badge-light" data-html="true"
                                data-content="<em>Example of user object data</em>
                                              <br> <b>userObject.username</b>: 'exampleuser'
                                              <br> <b>userObject.id</b>: '123456'
                                              <br> <b>userObject.is.online</b>: true
                                              <br> <b>userObject.is.follower</b>: true <br> <b>userObject.is.regular</b>: true
                                              <br> <b>userObject.is.subscriber</b>: true">
                          what's this?
                        </a>`
      for (let variable of variables) {
        $('[data-event-variables] small').append(
          `
          <div>
            <strong>$${variable}</strong> - ${translations.responses.variable[variable]}
            ${variable === 'userObject'
              ? whatsthis
              : ``}
          </div>
        `
        )

        if (variable === 'userObject') {
          $('[data-events-whats-this]').popover({trigger: 'hover'})
        }
      }
    } else {
      $('[data-event-variables]').css('display', 'none')
    }
    // !VARIABLES ///////////////////////////////////////////////////////////////

    // DEFINITIONS ////////////////////////////////////////////////////////////
    $('[data-event-definitions] .card-body').empty()
    if (_.size(definitions) > 0) {
      $('[data-event-definitions]').css('display', 'block')
      console.debug('Definitions', definitions)
      for (let [key, value] of Object.entries(definitions))
      {
        $('[data-event-definitions] .card-body').append(`
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text">${translations.events.definitions[key].label}</span>
            </div>
            <input id="definition-${key}" class="form-control" placeholder="${translations.events.definitions[key].placeholder}" value="${value}">
          </div>
        `)
      }
    } else {
      $('[data-event-definitions]').css('display', 'none')
    }
    // !DEFINITIONS ///////////////////////////////////////////////////////////
  })

  var supportedOperationsList = []
  eventsSocket.emit('list.supported.operations', (cb) => {
    supportedOperationsList = cb
    console.debug('Loaded list of supported operations:', supportedOperationsList)
  })

  // dynamic on change for operations
  $('[data-event-operations]').on('change', 'select', (ev) => {
    const operation = _.find(supportedOperationsList, (o) => o.id === ev.currentTarget.value)
    const definitions = _.get(operation, 'definitions', [])
    console.debug('Operation selected', operation)

    const createProperInput = (k, v) => {
      if (_.isBoolean(v)) {
        return `<button data-event-toggle-button data-id="${k}" data-value="${v}" style="flex: 1 1 auto;" class="btn ${v === true ? `btn-success` : `btn-danger`}">${translations.events.definitions[k][v]}</button>`
      } else if (_.isArray(v)) {
        let buttons = []
        for (let val of v) {
          buttons.push(`
            <label class="form-control btn btn-secondary ${buttons.length === 0 ? `active` : ``}">
              <input type="radio" name="radio-options-${k}" id="${k}-${val}" autocomplete="off" ${buttons.length === 0 ? `checked` : ``}> ${val}
            </label>
          `)
        }
        return `
          <div class="btn-group btn-group-toggle" data-toggle="buttons" style="flex: 1 1 auto; position: relative; left: 1px">
            ${buttons.join(' ')}
          </div>
        `
      } else {
        return `<input id="operation-definition-${k}" class="form-control" placeholder="${translations.events.definitions[k].placeholder}" value="${v}">`
      }
    }

    // DEFINITIONS ////////////////////////////////////////////////////////////
    const definitionsElement = $(ev.currentTarget).parents('.operation-group').children('.event-operation-definitions')
    definitionsElement.empty()
    console.debug('Definitions', definitions)
    for (let [key, value] of Object.entries(definitions))
    {
      definitionsElement.append(`
        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">${translations.events.definitions[key].label}</span>
          </div>
          ${createProperInput(key, value)}
        </div>
      `)
    }
    // !DEFINITIONS ///////////////////////////////////////////////////////////
  });

  $('[data-event-operations]').on('click', '[data-event-toggle-button]', ((ev) => {
    ev.preventDefault()
    const target = $(ev.currentTarget)
    const value = target.data('value') === 'true' ? false : true
    target
      .removeClass()
      .addClass('btn')
      .addClass(value ? 'btn-success' : 'btn-danger')
      .text(translations.events.definitions[target.data('id')][value])
      .data('value', value.toString())
  }))

  // HELPERS //////////////////////////////////////////////////////////////////
  var addEventOperation = (ev) => {
    ev.preventDefault()

    let operationOptions = () => {
      let r = []
      for (let id of _.map(supportedOperationsList, 'id')) r.push(`<option value="${id}">${translations[id]}</option>`)
      return r.join()
    }

    const id = new Date().getTime()
    $('[data-event-operations]').append(`
      <div class="operation-group" id="${id}">
        <div class="input-group">
          <select class="form-control" data-event-operation-select>
            ${operationOptions()}
          </select>
          <div class="input-group-append">
            <button class="btn btn-outline-danger" type="button" onclick="removeEventOperation(event, this)">
              <i class="fa fa-minus"></i>
            </button>
          </div>
        </div>
        <div class="event-operation-definitions"></div>
      </div>
    `)
    $(`#${id} select`).trigger('change')
  }

  var removeEventOperation = (ev, self) => {
    ev.preventDefault()
    $(self).parents('.operation-group').remove()
  }

  var saveChanges = (ev) => {
    ev.preventDefault()

    var eventListener = {
      name: null,
      event: {
        id: null,
        definitions: {}
      },
      operations: {}
    }
    for (let element of $('form#event-form')[0]) {
      console.warn('TODO: ADD REQUIRE CHECK')
      switch ($(element).prop('nodeName')) {
        case 'INPUT':
          if ($(element).attr('id') === 'event-listener-new-events-name') {
            eventListener.name = $(element).val()
          } else if ($(element).attr('id').startsWith('definition')) {
            let id = $(element).attr('id').split('-')[1]
            eventListener.event.definitions[id] = $(element).val()
          } else if ($(element).attr('id').startsWith('operation-definition')) {
            let id = $(element).attr('id').split('-')[2]
            let parentId = $(element).parents('.operation-group').attr('id')
            if (_.isNil(eventListener.operations[parentId])) eventListener.operations[parentId] = { id: null, definitions: {}}
            eventListener.operations[parentId].definitions[id] = $(element).val()
          } else if ($(element).attr('name').startsWith('radio-options')) {
            if ($(element).attr('checked')) {
              let id = $(element).attr('id').split('-')[0]
              let value = $(element).attr('id').split('-')[1]
              let parentId = $(element).parents('.operation-group').attr('id')
              if (_.isNil(eventListener.operations[parentId])) eventListener.operations[parentId] = { id: null, definitions: {}}
              eventListener.operations[parentId].definitions[id] = value
            }
          } else {
            console.debug('I dont know what to do', element)
          }
          break
        case 'TEXTAREA':
          if ($(element).attr('id') === 'event-listener-filter') {
            eventListener.event.filters = $(element).val()
          }
          break
        case 'SELECT':
          if ($(element).attr('id') === 'event-listener-new-events') {
            eventListener.event.id = $(element).val()
          } else if (!_.isNil($(element).data('event-operation-select'))) {
            let parentId = $(element).parents('.operation-group').attr('id')
            if (_.isNil(eventListener.operations[parentId])) eventListener.operations[parentId] = { id: null, definitions: {}}
            eventListener.operations[parentId].id = $(element).val()
          } else {
            console.debug('I dont know what to do', element)
          }
          break
        case 'BUTTON':
          if (!_.isNil($(element).data('event-toggle-button'))) {
            let parentId = $(element).parents('.operation-group').attr('id')
            if (_.isNil(eventListener.operations[parentId])) eventListener.operations[parentId] = { id: null, definitions: {}}
            eventListener.operations[parentId].definitions[$(element).data('id')] = $(element).data('value') === 'true'
          } else {
            console.debug('I dont know what to do', element)
          }
          break;
        default:
          console.debug('I dont know what to do', element)
      }
    }
    console.debug(eventListener)

    eventsSocket.emit('save-changes', eventListener, (err, cb) => {
      console.log(cb)
    })
  }

</script>
