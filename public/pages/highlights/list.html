<div id="systemHighlightsApp">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-9 col-md-8 col-sm-6">
        <span data-lang="menu.highlights" class="title text-default"></span>

        <div class="pt-3 pb-3 mt-3 mb-3 m-0 border-top border-bottom row">
          <div class="col-sm-12 text-right form-inline d-block">
            <button class="btn btn-dark border-0"><i class="fas fa-th-list"></i></button>
            <i class="fas fa-search text-muted" style="position: relative; left: 2.2rem;"></i>
            <input type="search" class="form-control w-auto pl-5" v-model="search" placeholder="Search...">
          </div>
        </div>

        <div v-if="filtered.length > 0" class="card" v-for="(item, index) of filtered" v-bind:class="{ 'mt-3': index !== 0 }">
          <div class="card-body row p-0">
            <div class="col-sm-11 pr-0">
              <a class="btn btn-block btn-outline-dark border-0 h-100 text-left p-0" target="_blank" v-bind:href="item.url + '?t=' + timestampToString(item.timestamp)">
                <img class="float-left pr-3" v-bind:src="generateThumbnail(item.thumbnail_url)">
                <div style="padding-top:0.8rem !important">
                  {{ item.title }}
                  <small class="d-block">
                    <i class="far fa-clock"></i> {{ timestampToString(item.timestamp) }}
                    <i class="pl-2 far fa-calendar-alt"></i> {{ new Date(item.created_at).toLocaleString() }}
                    <i class="pl-2 fas fa-gamepad"></i> {{ item.game }}
                  </small>
                </div>
              </a>
            </div>

            <div class="col-sm-1 pl-0">
              <button data-toggle="dropdown" class="btn btn-block btn-outline-dark border-0 h-100"><i class="fas fa-ellipsis-v"></i></button>
                <div class="dropdown-menu p-0">
                  <button class="dropdown-item p-2 pl-4 pr-4" style="cursor: pointer" v-on:click="deleteItem(item._id)"><i class="fas fa-trash-alt"></i> {{ commons.translate('delete') }}</button>
                </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-4 col-sm-6">
        <div class="sticky-top" style="top: 60px">
          <span class="title text-default">{{ commons.translate('settings') }}</span>
          <div class="widget pt-1 mt-3" style="height: auto">
            <div class="pt-1 pl-2 pr-2 pb-1">
              <toggle
                v-bind:value="enabled"
                v-on:update="enabled = !enabled; isDataChanged = true"></toggle>
            </div>

            <div class="p-0 pl-2 pr-2 " v-for="(value, defaultValue) of commands">
              <command-input
                class="pt-1 pb-1"
                v-bind:value="value"
                v-bind:command="defaultValue"
                v-on:update="commands[defaultValue] = $event; isDataChanged = true"></command-input>
            </div>
            <div class="p-2">
              <div v-if="isDataChanged" class="alert alert-danger">{{commons.translate('dialog.changesPending')}}</div>
              <button class="btn btn-block btn-primary" v-on:click="saveSettings" v-if="state.settings === 0">{{ commons.translate('dialog.buttons.saveChanges.idle') }}</button>
              <button disabled="disabled" class="btn btn-block btn-primary" v-on:click="saveSettings" v-if="state.settings === 1">
                <i class="fas fa-circle-notch fa-spin"></i> {{ commons.translate('dialog.buttons.saveChanges.progress') }}</button>
              <button disabled="disabled" class="btn btn-block btn-success" v-on:click="saveSettings" v-if="state.settings === 2">
                <i class="fas fa-check"></i> {{ commons.translate('dialog.buttons.saveChanges.done') }}</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  Vue.prototype.commons = commons

  function highlightsInit () {
    if (_.size(translations) === 0) return setTimeout(() => highlightsInit(), 1)
    var systemHighlightsApp = new Vue({
      el: '#systemHighlightsApp',
      components: {
        'toggle': toggleEnable,
        'command-input': commandInput
      },
      data: {
        search: '',

        items: {},

        commands: {},
        enabled: true,

        changed: [],
        isDataChanged: false,

        state: {
          settings: 0
        },
        socket: io('/system/Highlights', { query: "token=" + token }),
      },
      computed: {
        filtered: function () {
          if (this.search.length === 0) return this.items
          return this.items.filter((o) => {
            return !_.isNil(o.title.match(new RegExp(this.search, 'ig'))) || !_.isNil(o.game.match(new RegExp(this.search, 'ig')))
          })
        }
      },
      created: function () {
        this.socket.emit('list', (err, items) => {
          this.items = items
        })
        this.socket.emit('settings', (err, items) => {
          this.enabled = items.enabled
          this.commands = items.commands
        })
      },
      filters: {
        capitalize: function (value) {
          if (!value) return ''
          value = value.toString()
          return value.charAt(0).toUpperCase() + value.slice(1)
        }
      },
      methods: {
        timestampToString: function (value) {
          const string = (value.hours ? `${value.hours}h` : '') +
            (value.minutes ? `${value.minutes}m` : '') +
            (value.seconds ? `${value.seconds}s` : '')
          return string
        },
        generateThumbnail: function (url) {
          return url.replace('%{width}', '133').replace('%{height}', '75')
        },
        deleteItem: function (id) {
          this.socket.emit('delete', id, () => {
            this.items = this.items.filter((o) => o._id !== id)
          })
        },
        saveSettings: function () {
          this.state.settings = 1
          const settings = {
            commands: this.commands,
            enabled: this.enabled,
          }
          this.socket.emit('settings.update', settings, (err) => {
            this.state.settings = 2
            this.isDataChanged = false
            setTimeout(() => this.state.settings = 0, 1000)
          })
        }
      }
    })
  }
  highlightsInit()
</script>
