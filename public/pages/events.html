<!-- New Event Listener Dialog -->
<div class="modal fade" id="event-listener-new" tabindex="-1" role="dialog" aria-labelledby="event-listener-newLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="event-listener-newLabel">New event listener</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="event-listener-new-events-name">Name</label>
            <input class="form-control" type="text" id="event-listener-new-events-name" placeholder="Set name of your event listener (if empty id is set as name)"
            />
          </div>
          <div class="form-group">
            <label for="event-listener-new-events" data-lang="event"></label>
            <select class="form-control" data-load-events="1" id="event-listener-new-events"></select>
          </div>
          <div class="form-group">
            <label data-usable-events="1">Usable events variables</label>
            <small>
              <div id="usernameInfo">
                <strong>$username</strong>
                <span data-lang="events-user-triggered-event"></span>
              </div>
              <div id="methodInfo">
                <strong>$method</strong>
                <span data-lang="events-method-used-to-subscribe"></span>
              </div>
              <div id="monthsInfo">
                <strong>$months</strong>
                <span data-lang="events-months-of-subscription"></span>
              </div>
              <div id="monthsNameInfo">
                <strong>$monthsName</strong>
                <span data-lang="events-monthsName-of-subscription"></span>
              </div>
              <div id="messageInfo">
                <strong>$message</strong>
                <span data-lang="events-user-message"></span>
              </div>
              <div id="bitsInfo">
                <strong>$bits</strong>
                <span data-lang="events-user-message"></span>
              </div>
              <div id="reasonInfo">
                <strong>$reason</strong>
                <span data-lang="events-reason-for-ban-timeout"></span>
              </div>
              <div id="durationInfo">
                <strong>$duration</strong>
                <span data-lang="events-duration-of-timeout"></span>
              </div>
              <div id="durationCommercialInfo">
                <strong>$duration</strong>
                <span data-lang="events-duration-of-commercial"></span>
              </div>
              <div id="targetInfo">
                <strong>$target</strong>
                <span data-lang="events-target-of-your-hosting"></span>
              </div>
              <div id="viewersInfo">
                <strong>$viewers</strong>
                <span data-lang="events-viewers-of-hosting"></span>
              </div>
              <div id="gameInfo">
                <strong>$game</strong>
                <span data-lang="events-game-after-change"></span>
              </div>
              <div id="oldGameInfo">
                <strong>$oldGame</strong>
                <span data-lang="events-game-before-change"></span>
              </div>
            </small>
          </div>

          <div class="form-group">
              <button class="btn btn-outline-primary">
                <i class="fa fa-plus" aria-hidden="true"></i> Filter
              </button>
              <button class="btn btn-outline-primary">
                <i class="fa fa-plus" aria-hidden="true"></i> Operation
              </button>
            </div>

          <div class="card">
            <div class="card-header">
              Event settings
            </div>
            <div class="card-body">
              <div class="form-group" id="commandGroup" style="display: none">
                <label for="command" data-lang="command"></label>
                <input id="command" class="form-control" placeholder="Set your !command">
              </div>

              <div class="form-group" id="countGroup" style="display: none">
                <label for="count" data-lang="count"></label>
                <input id="count" class="form-control" placeholder="commands to activate">
              </div>

              <div class="form-group" id="timestampGroup" style="display: none">
                <label for="timestamp" data-lang="timestamp"></label>
                <input id="timestamp" class="form-control" placeholder="activate every x seconds">
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              Filters
            </div>
            <div class="card-body">
              <textarea class="form-control">$sender.username -eq 'soge__' || $sender.username -eq 'satont'</textarea>
              <select class="form-control">
                <option>AND</option>
                <option>OR</option>
              </select>
              <textarea class="form-control">$sender.is.follower is true</textarea>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              Operations
            </div>
            <div class="card-body">
              <div class="operation-group">
                <div class="input-group">
                  <select class="form-control" data-load-operations="1" id="event-listener-new-operations"></select>
                  <div class="input-group-append">
                    <button class="btn btn-outline-danger" type="button">
                      <i class="fa fa-minus"></i>
                    </button>
                  </div>
                </div>

                <div class="input-group" id="messageGroup">
                  <div class="input-group-prepend">
                    <span class="input-group-text" data-lang="message"></span>
                  </div>
                  <input id="message" class="form-control" placeholder="message to send">
                </div>
              </div>

              <hr>

              <div class="operation-group">
                <div class="input-group">
                  <select class="form-control" data-load-operations="1" id="event-listener-new-operations"></select>
                  <div class="input-group-append">
                    <button class="btn btn-outline-danger" type="button">
                      <i class="fa fa-minus"></i>
                    </button>
                  </div>
                </div>

                <div class="input-group" id="messageGroup">
                  <div class="input-group-prepend">
                    <span class="input-group-text" data-lang="message"></span>
                  </div>
                  <input id="message" class="form-control" placeholder="message to send">
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs">
  <li class="nav-item">
    <span data-lang="event-listeners" class="title text-default"></span>
  </li>
  <li class="nav-item">
    <button class="nav-link btn-outline-success plus-button" data-toggle="modal" data-target="#event-listener-new">
      <i class="fa fa-plus" aria-hidden="true"></i> EVENT
    </button>
  </li>
</ul>

<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="viewers">
    <div class="widget">

      <form class="form-inline form-chainops">


        <br>

        <div class="form-group" id="operationsGroup">
          <label for="Operations" data-lang="operation"></label>
          <select id="operations-list" class="form-control"></select>
        </div>

        <div class="form-group" id="messageGroup">
          <label for="message" data-lang="message"></label>
          <input id="message" class="form-control" placeholder="message to send">
        </div>

        <div class="form-group" id="command2Group" style="display: none">
          <label for="command2" data-lang="command"></label>
          <input id="command2" class="form-control" placeholder="!command to run">
        </div>

        <div class="form-group" id="quietGroup" style="display: none">
          <label for="quiet" data-lang="quiet"></label>
          <button class="btn btn-danger" id="quietToggle" data-lang="false"></button>
        </div>

        <div class="form-group" id="soundGroup" style="display: none">
          <label for="sound" data-lang="sound"></label>
          <input id="sound" class="form-control" placeholder="link or soundboard name">
        </div>

        <div class="form-group" id="emotesGroup" style="display: none">
          <label for="emotes" data-lang="emotes"></label>
          <input id="emotes" class="form-control" placeholder="Kappa :) purpleHeart">
        </div>

        <div class="form-group" id="commercialGroup" style="display: none">
          <label for="duration" data-lang="duration"></label>
          <select class="form-control" id="commercial-list">
            <option value="30">30s</option>
            <option value="60">60s</option>
            <option value="90">90s</option>
            <option value="120">120s</option>
            <option value="150">150s</option>
            <option value="180">180s</option>
          </select>
        </div>

        <button type="button" class="btn btn-success pull-right" data-lang="create-a-new-event-listener" onclick="newEvent()"></button>
        <div class="clearfix"></div>
      </form>
      <hr>

      <div id="events-current"></div>
    </div>
  </div>
</div>

<script>
  socket.emit('events.get');

  $("#quietToggle").on('click', function (ev) {
    ev.preventDefault()
    $el = $(ev.currentTarget)
    if ($el.text() === translations['false']) {
      $el.text(translations['true'])
      $el.removeClass()
      $el.addClass('btn btn-success')
    } else {
      $el.text(translations['false'])
      $el.removeClass()
      $el.addClass('btn btn-danger')
    }
  })

  $('[data-load-events="1"]').on('change', function (ev) {
    $('#commandGroup').css('display', 'none')
    $('#countGroup').css('display', 'none')
    $('#timestampGroup').css('display', 'none')
    $('#usernameInfo').css('display', 'none')
    $('#methodInfo').css('display', 'none')
    $('#monthsInfo').css('display', 'none')
    $('#monthsNameInfo').css('display', 'none')
    $('#messageInfo').css('display', 'none')
    $('#bitsInfo').css('display', 'none')
    $('#reasonInfo').css('display', 'none')
    $('#durationInfo').css('display', 'none')
    $('#durationCommercialInfo').css('display', 'none')
    $('#targetInfo').css('display', 'none')
    $('#viewersInfo').css('display', 'none')
    $('#gameInfo').css('display', 'none')
    $('#oldGameInfo').css('display', 'none')
    $('[data-usable-events="1"]').css('display', 'none')

    $('#command2').val('')
    $('#count').val('')
    $('#timestamp').val('')

    switch (ev.currentTarget.value) {
      case 'user-joined-channel':
      case 'user-parted-channel':
      case 'follow':
      case 'unfollow':
      case 'action':
      case 'mod':
        $('#usernameInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'subscription':
        $('#usernameInfo').css('display', 'block')
        $('#methodInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'commercial':
        $('#durationCommercialInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'resub':
        $('#usernameInfo').css('display', 'block')
        $('#monthsInfo').css('display', 'block')
        $('#monthsNameInfo').css('display', 'block')
        $('#messageInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'cheer':
        $('#usernameInfo').css('display', 'block')
        $('#bitsInfo').css('display', 'block')
        $('#messageInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'ban':
        $('#usernameInfo').css('display', 'block')
        $('#reasonInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'timeout':
        $('#usernameInfo').css('display', 'block')
        $('#reasonInfo').css('display', 'block')
        $('#durationInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'hosting':
        $('#targetInfo').css('display', 'block')
        $('#viewersInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'hosted':
        $('#viewersInfo').css('display', 'block')
        $('#usernameInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
        break
      case 'command-send-x-times':
        $('#commandGroup').css('display', 'block')
        $('#countGroup').css('display', 'block')
        $('#count').attr('placeholder', 'commands to activate')
        $('#timestampGroup').css('display', 'block')
        break
      case 'number-of-viewers-is-at-least-x':
        $('#countGroup').css('display', 'block')
        $('#count').attr('placeholder', 'viewers to activate')
        $('#timestampGroup').css('display', 'block')
        break
      case 'stream-is-running-x-minutes':
        $('#countGroup').css('display', 'block')
        $('#count').attr('placeholder', 'minutes to activate')
        break
      case 'every-x-seconds':
        $('#countGroup').css('display', 'block')
        $('#count').attr('placeholder', 'seconds to activate')
        break
      case 'game-changed':
        $('#gameInfo').css('display', 'block')
        $('#oldGameInfo').css('display', 'block')
        $('[data-usable-events="1"]').css('display', 'block')
    }
  })

  $('#operations-list').on('change', function (ev) {
    $('#messageGroup').css('display', 'none')
    $('#command2Group').css('display', 'none')
    $('#soundGroup').css('display', 'none')
    $('#emotesGroup').css('display', 'none')
    $('#quietGroup').css('display', 'none')
    $('#commercialGroup').css('display', 'none')

    $('#message').val('')
    $('#sound').val('')
    $('#command2').val('')
    $('#emotes').val('')

    switch (ev.currentTarget.value) {
      case 'send-chat-message':
      case 'send-twitter-message':
      case 'send-whisper':
        $('#messageGroup').css('display', 'block')
        break
      case 'run-command':
        $('#command2Group').css('display', 'block')
        $('#quietGroup').css('display', 'block')
        break
      case 'play-sound':
        $('#soundGroup').css('display', 'block')
        break
      case 'emote-explosion':
        $('#emotesGroup').css('display', 'block')
        break
      case 'start-commercial':
        $('#commercialGroup').css('display', 'block')
        break
    }
  })

  var newEvent = function () {
    let validated = true
    if ($('#commandGroup').css('display') !== 'none') {
      if ($('#command').val().length === 0) {
        $('#commandGroup').addClass('has-error')
        validated = false
      } else {
        $('#commandGroup').removeClass('has-error')
      }
      if (validated && !$('#command').val().startsWith('!')) $('#command').val('!' + $('#command').val()) // add ! if it doesn't start with one
    }

    if ($('#countGroup').css('display') !== 'none' && ($('#count').val().length === 0 || !_.isFinite(parseInt($(
        '#count').val(), 10)))) {
      $('#countGroup').addClass('has-error')
      validated = false
    } else {
      $('#countGroup').removeClass('has-error')
    }

    if ($('#timestampGroup').css('display') !== 'none' && ($('#timestamp').val().length === 0 || !_.isFinite(
        parseInt($('#timestamp').val(), 10)))) {
      $('#timestampGroup').addClass('has-error')
      validated = false
    } else {
      $('#timestampGroup').removeClass('has-error')
    }

    if ($('#messageGroup').css('display') !== 'none' && $('#message').val().length === 0) {
      $('#messageGroup').addClass('has-error')
      validated = false
    } else {
      $('#messageGroup').removeClass('has-error')
    }

    if ($('#command2Group').css('display') !== 'none') {
      if ($('#command2').val().length === 0) {
        $('#command2Group').addClass('has-error')
        validated = false
      } else {
        $('#command2Group').removeClass('has-error')
      }
      if (validated && !$('#command2').val().startsWith('!')) $('#command2').val('!' + $('#command2').val()) // add ! if it doesn't start with one
    }

    if ($('#soundGroup').css('display') !== 'none' && $('#sound').val().length === 0) {
      $('#soundGroup').addClass('has-error')
      validated = false
    } else {
      $('#soundGroup').removeClass('has-error')
    }

    if ($('#emotesGroup').css('display') !== 'none' && $('#emotes').val().length === 0) {
      $('#emotesGroup').addClass('has-error')
      validated = false
    } else {
      $('#emotesGroup').removeClass('has-error')
    }

    if (!validated) {
      return 0
    }

    var data = {
      event: $('#events-list').val(),
      operation: {
        name: $('#operations-list').val(),
        duration: $('#commercial-list').val(),
        send: $('#message').val(),
        sound: $('#sound').val(),
        command: $('#command2').val(),
        emotes: $('#emotes').val(),
        quiet: $('#quietToggle').text() === translations['true'] ? true : false
      },
      definition: {
        command: $('#command').val().length > 0 ? $('#command').val() : null,
        count: $('#count').val().length > 0 ? $('#count').val() : null,
        timestamp: $('#timestamp').val().length > 0 ? $('#timestamp').val() : null
      },
    }

    switch ($('#events-list').val()) {
      case 'user-joined-channel':
      case 'user-parted-channel':
      case 'follow':
      case 'unfollow':
      case 'subscription':
      case 'resub':
      case 'stream-started':
      case 'stream-stopped':
      case 'cheer':
      case 'clearchat':
      case 'action':
      case 'ban':
      case 'hosting':
      case 'hosted':
      case 'mod':
      case 'timeout':
      case 'commercial':
      case 'game-changed':
        delete data.definition
    }
    socket.emit('events.new', data)
    $('#messageGroup').css('display', 'block')
    $('#message').val('')
    $('#soundGroup').css('display', 'none')
    $('#emotesGroup').css('display', 'none')
    $('#command2Group').css('display', 'none')
    $('#quietGroup').css('display', 'none')
    $('#countGroup').css('display', 'none')
    $('#commercialGroup').css('display', 'none')
  }

  socket.off('events')
  socket.on('events', function (data) {
    $('#events-list').empty()
    $('#events-current').empty()
    $('#operations-list').empty()

    _.each(data.events, function (o, k) {
      $('[data-load-events="1"]').append(
        $('<option></option').attr('value', k).text(translations[k]))
      $('[data-load-events="1"]').trigger('change') // manually trigger change to load correct data

      if (o.length) {
        let div_part
        let div_main = $('<div id="' + k + '"></div>')

        div_part = $('<div style="min-width:14%"></div>')
          .append($('<label></label>').text(translations['event']))
          .append($('<div></div>').text(translations[k]))
        div_main.append(div_part)

        let firstDefinition = true
        _.each(o, function (obj) {
          let definition = null
          _.each(obj, function (operation) {
            let div_op = $('<div class="operation" data-event="' + k + '"></div>')
            // is definition
            let div_def
            if (operation.definition) {
              definition = operation
              if (!firstDefinition) {
                div_def = $(
                  '<div class="definition" style="position:relative; left: 200px;"></div>')
              } else {
                div_def = $(
                  '<div class="definition" style="position:absolute; left: 220px;"></div>')
              }
              firstDefinition = false

              if (operation.command) {
                div_part = $(
                    '<div style="min-width:100px;display:block;padding-top:0;" ></div>')
                  .append($('<label></label>').text(translations['command']))
                  .append($('<div style="display:block;"></div>').text(operation.command))
                div_def.append(div_part)
              }
              if (operation.tCount) {
                div_part = $(
                    '<div style="min-width:100px;display:block;padding-top:0;" ></div>')
                  .append($('<label></label>').text(translations['count']))
                  .append($('<div style="display:block;"></div>').text(operation.tCount))
                div_def.append(div_part)
              }
              if (operation.viewers) {
                div_part = $(
                    '<div style="min-width:100px;display:block;padding-top:0;" ></div>')
                  .append($('<label></label>').text(translations['count']))
                  .append($('<div style="display:block;"></div>').text(operation.viewers))
                div_def.append(div_part)
              }
              if (operation.tTimestamp) {
                div_part = $(
                    '<div style="min-width:100px;display:block;padding-top:0;" ></div>')
                  .append($('<label></label>').text(translations['timestamp']))
                  .append($('<div style="display:block"></div>').text(operation.tTimestamp))
                div_def.append(div_part)
              }
              div_main.append(div_def)
            } else {
              div_op.data('name', operation.name)
              div_part = $('<div></div>')
                .append($('<label></label>').text(translations['operation']))
                .append($('<div></div>').text(translations[operation.name]))
              div_op.append(div_part)

              switch (operation.name) {
                case 'send-chat-message':
                case 'send-twitter-message':
                case 'send-whisper':
                  div_op.data('send', operation.send)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text(translations['message']))
                    .append($('<div></div>').text(operation.send))
                  break
                case 'run-command':
                  div_op.data('command', operation.command)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text((operation.quiet ? translations['quiet'] +
                      ' ' : '') + translations['command']))
                    .append($('<div></div>').text(operation.command))
                  break
                case 'play-sound':
                  div_op.data('sound', operation.sound)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text(translations['sound']))
                    .append($('<div></div>').text(operation.sound))
                  break
                case 'emote-explosion':
                  div_op.data('emotes', operation.emotes)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text(translations['emotes']))
                    .append($('<div></div>').text(operation.emotes))
                  break
                case 'start-commercial':
                  div_op.data('duration', operation.duration)
                  div_part = $('<div></div>')
                    .append($('<label></label>').text(translations['duration']))
                    .append($('<div></div>').text(operation.duration + 's'))
                  break
              }

              if (!_.isNil(definition) && _.size(definition) > 1) {
                div_op.data('definition', definition)
              }
              div_op.append(div_part)
              div_main.append(div_op)
            }
          })
        })
        $('#events-current').append(div_main)
      }
    })
    _.each(data.operations, function (o) {
      if (o === 'log') return true
      $('[data-load-operations="1"]').append(
        $('<option></option').attr('value', o).text(translations[o])
      )
    })
  })

</script>
