<!doctype html>
<html lang="en">

<head>
  <title></title>
  <meta charset="utf-8">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#f4f5f6">
  <meta name="apple-mobile-web-app-status-bar-style" content="#f4f5f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Poppins|PT+Sans|PT+Sans+Narrow|PT+Mono" rel="stylesheet">
  <link href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" rel="stylesheet">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="./dist/css/light.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="./dist/css/sortable-theme-bootstrap.css">
  <link rel="stylesheet" href="./dist/bootstrap-toggle/css/bootstrap-toggle.min.css" />
  <link rel="stylesheet" href="./dist/bootstrap-slider/css/bootstrap-slider.min.css" />
  <link rel="stylesheet" href="./dist/gridstack/css/gridstack.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/addon/lint/lint.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <!-- changelog modal dialog -->
  <div class="modal" id="new_version_dlg" tabindex="-1" role="dialog" aria-labelledby="new_version_dlg">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Changelog
            <small id="sogebot-version"></small>
          </h4>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">
            <i data-lang="close"></i>
          </button>
          <a class="btn btn-primary" href="https://github.com/sogehige/sogeBot/releases">Go to release download</a>
        </div>
      </div>
    </div>
  </div>


  <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
    <a class="navbar-brand" href="#"><strong id="bot_name"></strong> <span id="current_version"></span></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault"
      aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav mr-auto" id="menu-main">
        <li class="nav-item" id="menuDashboard">
          <a href="#" data-page="dashboard" class="nav-link active" data-lang="dashboard"></a>
        </li>
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
            <span data-lang="manage"></span>
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" id="menu-manage"></ul>
        </li>
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
            <span data-lang="settings"></span>
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" id="menu-settings"></ul>
        </li>
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
            <span data-lang="menu.registry"></span>
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" id="menu-registry"></ul>
        </li>
      </ul>

      <ul class="navbar-nav mr-auto">
        <li class="nav-item page-menu" style="font-size: 0.6rem; position: relative; top: .2rem">
          <a class="alert alert-warning" style="padding:0; cursor: pointer;" id="APIStatus" data-page="apistats" title="API checking" >API</a>
          <span class="alert alert-warning" style="padding:0;" id="TMIStatus" title="TMI checking">TMI</span>
          <span class="alert alert-warning" style="padding:0;" id="SOCStatus" title="SOC checking">SOC</span>
          <span class="alert alert-warning" style="padding:0;" id="MODStatus" title="MOD checking">MOD</span>
          <span class="alert alert-warning" style="padding:0;" id="RESStatus" title="RES checking">0ms</span>
        </li>
      </ul>

      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="btn btn-outline-danger" href="#" id="new-version-notice" style="display: none; font-weight: bold; cursor: pointer;"
            data-toggle="modal" data-target="#new_version_dlg">
            <i class="fas fa-code-fork" aria-hidden="true"></i> Version <span id="version"></span> available
          </a>
        </li>
      </ul>
      <div>
        <button class="btn btn-xs btn-light dropdown-toggle" type="button" id="settingsButton" data-toggle="dropdown" aria-haspopup="true"
          aria-expanded="false">
          <i class="fas fa-bars" aria-hidden="true"></i>
        </button>
        <div class="dropdown-menu dropdown-menu-right" style="right: 0; left: auto;" aria-labelledby="settingsButton">
          <button class="dropdown-item text-success" onclick="joinBot()">
            <i class="fas fa-sign-in-alt"></i>
            join channel
          </button>
          <button class="dropdown-item text-danger" onclick="leaveBot()">
            <i class="fas fa-sign-out-alt"></i>
            leave from channel
          </button>
          <br/>

          <h6 class="dropdown-header">UI</h6>
          <button class="dropdown-item" id="percentage-btn" data-show-percentage="true" onclick="switchPercentageShow()">
            <i class="far fa-check-square" aria-hidden="true"></i>
            Percentage in stats
          </button>
          <button class="dropdown-item" id="showdiff-btn" data-shortennumber="true" onclick="switchShowDiff()">
            <i class="far fa-check-square" aria-hidden="true"></i>
            Show average difference
          </button>
          <button class="dropdown-item" id="shortennumber-btn" data-shortennumber="true" onclick="switchShortenNumbers()">
            <i class="far fa-check-square" aria-hidden="true"></i>
            Shorten long numbers: 10000 => 10k
          </button>
          <button class="dropdown-item" id="sticky-btn" data-sticky="true" onclick="switchSticky()">
            <i class="far fa-check-square" aria-hidden="true"></i>
            Keep stats sticky on scroll
          </button>
          <button class="dropdown-item" id="stats-btn" data-show-stats="true" onclick="switchStats()">
            <i class="far fa-check-square" aria-hidden="true"></i>
            <span data-lang="stats-panel.show">Quick stats</span>
          </button>

          <h6 class="dropdown-header">BOT</h6>
          <button class="dropdown-item" id="mute-btn" data-muted="false" onclick="switchMute()">
            <i class="far fa-square" aria-hidden="true"></i>
            <span data-lang="mute"></span>
          </button>
          <button class="dropdown-item" id="me-btn" onclick="switchMe()">
            <i class="far fa-square" aria-hidden="true"></i>
            use /me
          </button>

          <h6 class="dropdown-header">THEMES</h6>
          <button class="dropdown-item" id="theme-btn" onclick="switchTheme()" data-lang="dark"></button>
        </div>
      </div>
    </div>
  </nav>

  <!-- CHANGE TITLE/GAME DLG -->
  <div class="modal" id="game_and_title_dlg" tabindex="-1" role="dialog" aria-labelledby="game_and_title_dlg">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" data-lang="change-game"></h4>
        </div>
        <div class="modal-body dlg-game-and-title">
          <div id="carousel-games" class="carousel" data-interval="false" data-keyboard="false">
            <!-- Wrapper for slides -->
            <div class="carousel-inner carousel-games-inner" role="listbox"></div>

            <!-- Controls -->

            <a class="carousel-control-prev" href="#carousel-games" role="button" data-slide="prev">
              <i class="fas fa-chevron-left" aria-hidden="true"></i>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#carousel-games" role="button" data-slide="next">
              <i class="fas fa-chevron-right" aria-hidden="true"></i>
              <span class="sr-only">Next</span>
            </a>
          </div>
          <div class="form-group has-feedback" style="padding-top: 1rem;" id="change-game-group">
            <input type="text" class="form-control" id="change-game-input" placeholder="Add new game" onkeyup="changeGT.gameInput(this)">
            <ul id="change-game-search-list"></ul>
            <div class="invalid-feedback">
              Please provide a valid game.
            </div>
          </div>
        </div>
        <div class="modal-header" style="padding-top: 0">
          <h4 class="modal-title">
            <i data-lang="change-title"></i>
            <small id="titleForGame"></small>
          </h4>
        </div>
        <div class="modal-body dlg-game-and-title">
          <div id="titles-list"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger disabled" style="display: none" id="title-error">
            <i data-lang="custom-title-empty-error"></i>
          </button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">
            <i data-lang="close"></i>
          </button>
          <button type="button" class="btn btn-primary" onclick="changeGT.save()">
            <i data-lang="save-changes"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SNIPPETS -->
  <div class="stream-info-container container-fluid" id="quickStatsApp">
    <div class="row">
      <div class="col-sm stream-info" onclick="saveHighlight()">
        <h2>
          <i data-lang="uptime"></i>
          <small data-lang="click-to-highlight"></small>
        </h2>
        <span class="data" id="uptime">{{ uptime }}</span>
        <span class="stats">&nbsp;</span>
      </div>

      <div class="col-sm stream-info" v-on:click="toggleViewerShow">
        <h2>
          <i data-lang="viewers"></i>
          <small data-lang="click-to-toggle-display"></small>
        </h2>
        <span class="data" v-html="currentViewersComputed"></span>
        <span class="stats">&nbsp;</span>
      </div>

      <div class="col-sm stream-info" v-on:click="toggleViewerShow">
        <h2>
          <i data-lang="max-viewers"></i>
          <small data-lang="click-to-toggle-display"></small>
        </h2>
        <span class="data" v-html="maxViewersComputed"></span>
        <span class="stats" v-html="difference(averageStats.maxViewers, maxViewersComputed)"></span>
      </div>

      <div class="col-sm stream-info" v-on:click="toggleViewerShow">
        <h2>
          <i data-lang="new-chatters"></i>
          <small data-lang="click-to-toggle-display"></small>
        </h2>
        <span class="data" v-html="newChattersComputed"></span>
        <span class="stats" v-html="difference(averageStats.newChatters, newChattersComputed)"></span>
      </div>

      <div class="col-sm stream-info">
        <h2 data-lang="chat-messages"></h2>
        <span class="data" v-bind:title="chatMessages">{{ chatMessages | shortenNumber(b_shortenNumber) }}</span>
        <span class="stats" v-html="difference(averageStats.chatMessages, chatMessages)"></span>
      </div>

      <div class="col-sm stream-info">
        <h2 data-lang="views"></h2>
        <span class="data" v-bind:title="currentViews">{{ currentViews | shortenNumber(b_shortenNumber) }}</span>
        <span class="stats" v-html="difference(averageStats.currentViews, currentViews)"></span>
      </div>

      <div class="col-sm stream-info">
        <h2 data-lang="hosts"></h2>
        <span class="data">{{ currentHosts }}</span>
        <span class="stats" id="curHostsChange">&nbsp;</span>
      </div>

      <div class="col-sm stream-info">
        <h2 data-lang="followers"></h2>
        <span class="data" v-bind:title="currentFollowers">{{ currentFollowers | shortenNumber(b_shortenNumber) }}</span>
        <span class="stats" v-html="difference(averageStats.currentFollowers, currentFollowers)"></span>
      </div>

      <div class="col-sm stream-info">
        <h2 data-lang="subscribers"></h2>
        <span class="data">{{ currentSubscribers }}</span>
        <span class="stats" v-html="difference(averageStats.currentSubscribers, currentSubscribers)"></span>
      </div>

      <div class="col-sm stream-info">
        <h2 data-lang="bits"></h2>
        <span class="data" v-bind:title="currentBits">{{ currentBits | shortenNumber(b_shortenNumber) }}</span>
        <span class="stats" v-html="difference(averageStats.currentBits, currentBits)"></span>
      </div>

      <div class="col-sm stream-info">
        <h2 data-lang="tips"></h2>
        <span class="data">{{ Number(currentTips).toFixed(2) }}</span><span class="data ml-0 pl-0">{{ currency }}</span>
        <span class="stats" v-html="difference(averageStats.currentTips, currentTips)"></span>
      </div>
    </div>

    <div class="row">
      <div class="col-md stream-info" onclick="changeGT.showDlg()">
        <h2>
          <i data-lang="game"></i>
          <small data-lang="click-to-change"></small>
        </h2>
        <span class="data" id="game" data-lang="not-available"></span>
      </div>

      <div class="col stream-info" onclick="changeGT.showDlg()">
        <h2>
          <i data-lang="title"></i>
          <small data-lang="click-to-change"></small>
        </h2>
        <span class="data" id="title" data-lang="not-available"></span>
      </div>
    </div>
  </div>

  <div class="container-fluid" style="overflow-x: hidden;">
    <!-- widgets -->
    <span class="widgets p-0">
      <div id="widgets"></div>
    </span>
  </div>

  <div class="pages-wrapper pt-2 pb-5">
    <div class="container-fluid">
      <div id="pages"></div>
    </div>
  </div>

  <footer class="footer">
    <a href="https://github.com/sogehige/SogeBot">GitHub</a> |
    <a href="https://github.com/sogehige/SogeBot/issues">Issues</a> |
    <a href="https://github.com/sogehige/SogeBot/blob/master/LICENSE">MIT License</a>
  </footer>

  <!-- jQuery and Popper (necessary for Bootstrap's JavaScript plugins) -->
  <script src="./dist/jquery/js/jquery.min.js"></script>
  <script src="./dist/popper.js/js/popper.min.js"></script>
  <!-- Router -->
  <script src="./dist/page/js/page.js"></script>
  <!-- LoDash goodness -->
  <script src="./dist/lodash/js/lodash.min.js"></script>
  <!-- Widgets drag'n'drop -->
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <script src="./dist/gridstack/js/gridstack.all.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="./dist/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="./dist/sortablejs/js/Sortable.min.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="./dist/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>
  <script type="text/javascript" src="./dist/bootstrap-slider/js/bootstrap-slider.min.js"></script>
  <script type="text/javascript" src="./dist/bootstrap-menu/js/BootstrapMenu.min.js"></script>
  <script type="text/javascript" src="./dist/chart.js/js/Chart.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment-with-locales.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.3.1/markdown-it.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue2-datepicker@2.4.1/lib/index.min.js"></script>
  <script type="text/javascript" src="/auth/token.js"></script>
  <script type="text/javascript" src="./dist/js/commons/commons.js"></script>
  <script type="text/javascript" src="./dist/js/components/components.js"></script>
  <script src="/dist/velocity-animate/js/velocity.min.js"></script>
  <!-- CodeMirror textarea editor -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/codemirror.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/mode/javascript/javascript.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/mode/htmlmixed/htmlmixed.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/mode/xml/xml.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/addon/lint/javascript-lint.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.2/addon/lint/lint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.9.5/jshint.min.js"></script>
  <!-- Prism code markup -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.min.js"></script>

  <!-- development version, includes helpful console warnings -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <!-- production version, optimized for size and speed --
  <script src="https://cdn.jsdelivr.net/npm/vue"></script-->
  <script src="./dist/js/main.js"></script>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/js/tempusdominus-bootstrap-4.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />

  <script>
    if (typeof token === 'undefined') {
      $('body').empty().append(`
      <div class="alert alert-danger ml-5 mr-5" role="alert">
        This domain is not set as accessible in your <strong>config.json</strong>. Update your file and restart a bot to propagate changes. Example below:
      </div>
      <pre class="alert alert-info ml-5 mr-5" style="font-family: Monospace">
  ... config.json ...
  "panel": {
    "__COMMENT__": "set correctly your domain and to be safe, change your token",
    "username": "***",
    "password": "***",
    "port": ***,
    "domain": "yourdomain1, ${window.location.host.split(':')[0]}",
    "token": "***"
  },
  ... config.json ...
      </pre>
      `)
    }

    $('title').text(`${name.toUpperCase()}`)
    $('#bot_name').text(`${name.toUpperCase()}`)

    var socket = io({
      query: "token=" + token
    });

    var highlightsSocket = io('/systems/highlights', { query: "token=" + token })
    var loadedMenu = false
    var addingWidget = false
    var systems
    var configuration

    var translations = {}

    console.debug('EMIT [getVersion]')
    socket.emit('getVersion')
    socket.once('version', function (version) {
      $('#current_version').text(version)
      $.get('https://api.github.com/repos/sogehige/sogebot/releases/latest', function (response) {
        var md = new markdownit()
        var commits = new RegExp('(?!added)[0-9a-f]{5,40}', 'gm')
        let commits_match = response.body.match(commits)
        if (!_.isNil(commits_match)) {
          for (let commit of commits_match) {
            commit_short = commit.substring(0, 6)
            response.body = response.body.replace(commit, '[' + commit_short +
              '](https://github.com/sogehige/sogeBot/commit/' + commit_short + ')')
          }
        }

        var issues = new RegExp('#[0-9]{1,4}', 'gm')
        let issues_match = response.body.match(issues)
        if (!_.isNil(issues_match)) {
          for (let issue of issues_match) {
            response.body = response.body.replace(issue, '[' + issue +
              '](https://github.com/sogehige/sogeBot/issues/' + issue.replace('#', '') + ')')
          }
        }

        $('#new_version_dlg .modal-body').html(md.render(response.body.replace('**Changelog**', '').trim()))
        $('#new_version_dlg .modal-header small').text(response.tag_name)
        console.debug('GITHUB version', response.tag_name)
        console.debug('LOCAL version', version)
        $('#version').text(response.tag_name)
        $('title').text($('title').text() + ' ' + version)

        let botVersion = version.replace('-SNAPSHOT', '').split('.')
        let gitVersion = response.tag_name.split('.')

        let isNewer = false
        for (let index in botVersion) {
          botVersion[index] = parseInt(botVersion[index], 10)
          gitVersion[index] = parseInt(gitVersion[index], 10)
          if (botVersion[index] < gitVersion[index]) {
            isNewer = true
            break
          } else if (botVersion[index] === gitVersion[index]) continue
          else {
            isNewer = false
            break
          }
        }
        if (isNewer) $('#new-version-notice').css('display', 'inline')
      })
    })

    socket.emit('systems', function (err, data) {
      console.debug('EMIT [systems]')
      console.log(data)
      systems = data
    })

    console.debug('EMIT [getConfiguration]')
    socket.emit('getConfiguration')
    socket.on('configuration', function (data) {
      configuration = data
      moment.locale(data.lang) // set moment locale
      /* THEME */
      if (data.theme === 'dark') {
        $('head').append('<link rel="stylesheet" href="./dist/css/dark.css">')
        var btn = $('#theme-btn')
        btn.text(translations['light'])
      }

      /* MUTE BUTTON */
      var btn = $('#mute-btn')
      btn.data('muted', !data.mute)
      switchMute(false)

      /* PERCENTAGE BUTTON */
      var btn = $('#percentage-btn')
      btn.data('showPercentage', !data.percentage)
      switchPercentageShow(false)

      /* SHORTEN NUMBER BUTTON */
      var btn = $('#shortennumber-btn')
      btn.data('switchShortenNumbers', !data.shortennumbers)
      switchShortenNumbers(false)

      /* SHOW DIFF BUTTON */
      var btn = $('#showdiff-btn')
      btn.data('switchShowDiff', !data.showdiff)
      switchShowDiff(false)

      /* STICKY BUTTON */
      var btn = $('#sticky-btn')
      btn.data('switchSticky', !data.stickystats)
      switchSticky(false)

      /* ME BUTTON */
      var btn = $('#me-btn')
      btn.data('sendWithMe', !data.sendWithMe)
      switchMe(false)
    })

    setInterval(function () {
      console.debug('EMIT [getConnectionStatus]');
      socket.emit('getConnectionStatus')
      setStatus('SOC', socket.connected ? 3 : 0)
    }, 1000)
    socket.on('connectionStatus', function (data) {
      _.each(data, function (status, conn) {
        setStatus(conn, status)
      })
    })

    /* ROUTERS */
    let currentPage = null
    page('/', function(p){
      const id = p.hash.length === 0 ? 'dashboard' : p.hash
      if (currentPage === id) return
      else currentPage = id
      var visibility = id !== 'dashboard' ? 'none' : 'flex'
      var visibilityBlock = id !== 'dashboard' ? 'none' : 'block'

      $("#pages").empty()

      if (id !== 'dashboard') $("#pages").append($('<div id="P' + id + '">').load('pages/' + id + '.html',
        function (err) {
          commons.translate()
          $('a[data-toggle="tab"]').off()
          $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr("href") // activated tab
            if (target === '#manage') {
              $('.plus-button').prop('disabled', false)
              $('.plus-button').removeClass('disabled')
            } else {
              $('.plus-button').addClass('disabled')
              $('.plus-button').prop('disabled', true)
            }
          })
        }))
      $(".widgets").css('display', visibilityBlock)
    })
    page({ popstate:true })

    /* MENU */
    socket.on('menu', function (menu) {
      if (loadedMenu) return
      /* at first, clear all menu */
      $('#menu-*').empty()
      var games = false // we want only games settings once
      var systems = false // we want only systems settings once
      var integrations = false // we want only systems settings once
      var overlays = false // we want only overlays settings once
      var registry = false // we want only registry settings once
      var core = false // we want only core settings once
      _.each(menu, function (obj) {
        if (obj.id !== 'dashboard') {
          if ((obj.id === 'systems') && systems) return
          if ((obj.id === 'overlays') && overlays) return
          if ((obj.id === 'integrations') && integrations) return
          if ((obj.id === 'registry') && registry) return
          if ((obj.id === 'games') && games) return
          if ((obj.id === 'core') && core) return
          $('#menu-' + obj.category).append('<li class="nav-item"><a class="nav-link" href="#' + obj.id.replace(/\./g, '/') + '" data-page="' +
            obj.id.replace(/\./g, '/') + '" data-lang="menu.' + obj.name +
            '"></a></li>')
        }
        if (obj.id === 'systems') systems = true
        if (obj.id === 'overlays') overlays = true
        if (obj.id === 'integrations') integrations = true
        if (obj.id === 'registry') registry = true
        if (obj.id === 'core') core = true
        if (obj.id === 'games') games = true
      })
      loadedMenu = true

      $(".page-menu a,#menu-main a").on('click', function (ev) {
        ev.preventDefault()
        if (!_.isNil(ev.currentTarget.dataset.page)) page('/#' + ev.currentTarget.dataset.page)
        $(".page-menu a,#menu-main a").removeClass('active')
        $(ev.currentTarget).addClass('active')
      })
    })

    // addWidget
    $("#addWidget").on('click', function (ev) {
      if (!addingWidget) {
        $(".widgets").append($('<div class="col">').load('widgets/widget_create.html'))
        $("#addWidget").css('display', 'none')
        addingWidget = true
      }
    })

    Vue.prototype.commons = commons
    var quickStatsApp = new Vue({
      el: '#quickStatsApp',

      data: {
        socket: io({ query: "token=" + token }),
        averageStats: {},

        hideStats: false,
        b_shortenNumber: true,
        b_showAvgDiff: false,
        b_percentage: false,

        timestamp: null,
        uptime: '--:--:--',
        currentViewers: 0,
        maxViewers: 0,
        chatMessages: 0,
        newChatters: 0,
        currentHosts: 0,
        currentViews: 0,
        currentBits: 0,
        currentSubscribers: 0,
        currentFollowers: 0,
        currentTips: 0,
        currency: 'n/a'

      },
      watched: {
        timestamp: function () {
          if (this.uptime === '') this.uptime = '00:00:00'
          if (this.uptime === '00:00:00') {
            this.currentViewers = 0
            this.maxViewers = 0
            this.chatMessages = 0
            this.newChatters = 0
            this.currentHosts = 0
          }
        }
      },
      computed: {
        currentViewersComputed: function () {
          return !this.hideStats ? this.currentViewers : `<small>${commons.translate('hidden')}</small>`
        },
        maxViewersComputed: function () {
          return !this.hideStats ? this.maxViewers : `<small>${commons.translate('hidden')}</small>`
        },
        newChattersComputed: function () {
          return !this.hideStats ? this.newChatters : `<small>${commons.translate('hidden')}</small>`
        }
      },
      methods: {
        difference: function (number, current) {
          number = number || 0
          if (_.isNaN(Number(current)) || this.uptime === '00:00:00' || !this.b_showAvgDiff) return '' // return nothing if current is not number (hidden, etc)
          else if (number === 0) return ''
          else {
            let isPositive = current - number >= 0
            let f_difference =  Math.abs(this.b_percentage ? (Math.round((current - number) / number * 1000) / 10) : current - number)
            f_difference = this.b_percentage ? `${f_difference}%` : this.$options.filters.shortenNumber(f_difference, this.b_shortenNumber)

            if (current - number === 0) {
              return ''
            } else if (isPositive) {
              return `<small class="stats-up text-success"><i class="fas fa-caret-up"></i>${f_difference}</small>`
            } else {
              return `<small class="stats-down text-danger"><i class="fas fa-caret-down"></i>${f_difference}</small>`
            }
          }
        },
        toggleViewerShow: function () {
          this.hideStats = !this.hideStats
        }
      },
      created: function () {
        this.socket.emit('getLatestStats')
        this.socket.emit('panel.sendStreamData')

        setInterval(() => {
          this.socket.emit('getLatestStats')
          this.socket.emit('panel.sendStreamData')
        }, 1000)

        this.socket.on('latestStats', (data) => { this.averageStats = data })
        this.socket.on('stats', (data) => {
          for (let [key, value] of Object.entries(data)) {
            this[key] = value // populate data
          }
          this.timestamp = new Date()
        })
      },
      filters: {
        shortenNumber: function (number, shortify) {
          if (!shortify || Number(number) <= 10000) return number
          var SI_PREFIXES = ["", "k", "M", "G", "T", "P", "E"];
          // what tier? (determines SI prefix)
          var tier = Math.log10(number) / 3 | 0;
          // if zero, we don't need a prefix
          if(tier == 0) return number;
          // get prefix and determine scale
          var prefix = SI_PREFIXES[tier];
          var scale = Math.pow(10, tier * 3);
          // scale the number
          var scaled = number / scale;
          // format number and add prefix as suffix
          return scaled.toFixed(1) + prefix;
        }
      }
    })

    /* STATS */
    socket.on('stats', async function (data) {
      let title = await generateTitle(data.status, data.rawStatus)
      $("#title").html(title)

      $('#title').prop('title', data.rawStatus)
      $("#game").text(data.game)
      $('#game').prop('title', data.game)
    })

    socket.on('sendGameFromTwitch', function (status) {
      changeGT.gameInputStatus(status)
    })

    socket.on('sendUserTwitchGamesAndTitles', function (data) {
      delete data._id
      changeGT.update(data)
    })

    socket.on('lang', function (data) {
      translations = data
      let elements = $('[data-lang]')
      for (let el of elements) {
        let translation = _.get(translations, $(el).data('lang'), null)
        if(_.isNil(translation)) {
          $(el).html(`{${$(el).data('lang')}}`)
        } else {
          $(el).html(translation)
        }
      }
      $('#change-game-input').attr('placeholder', translations['create-and-use-a-new-game'])
      $('#change-title').attr('placeholder', translations['create-and-use-a-new-title'])
    })

    socket.off('play-sound')
    socket.on('play-sound', function (sound) {
      var audio = new Audio(sound).play()
    })

    var changeGT = {
      selectedGame: '',
      selectedTitle: '',

      icon: $("#change-game-icon"),
      ticon: $("#change-title-icon"),
      group: $("#change-game-group"),
      tgroup: $("#change-title-group"),

      timeout: null,
      lastSearch: '',

      cachedData: null,

      setGameInput: function (el) {
        $('#change-game-search-list').css('display', 'none')
        $('#change-game-input').val(el.dataset.game)
        $('#change-game-input').keyup()
        this.group.children('input').removeClass().addClass('form-control is-checking')
      },
      gameInput: function (el) {
        if ($(el).val().trim() === this.lastSearch) return

        clearTimeout(this.timeout)
        var self = this
        this.timeout = setTimeout(function () {
          self.group.removeClass()
          self.group.addClass('form-group')
          self.lastSearch = $(el).val().trim()
          if ($(el).val().trim() !== '') {
            self.group.children('input').removeClass().addClass('form-control is-checking')
            console.debug('EMIT [getGameFromTwitch]', $(el).val())
            socket.emit('getGameFromTwitch', $(el).val())
          }
        }, 1000)
      },
      gameInputStatus: function (games) {
        console.group('gameInputStatus')
        console.debug('Game list', games)
        console.debug('Selected game', $('#change-game-input').val())
        console.debug('Is searched game in list', _.includes(games, $('#change-game-input').val()))
        console.groupEnd()
        if (games !== false) {
          if (_.includes(games, $('#change-game-input').val())) {
            this.group.children('input').removeClass().addClass('form-control is-valid')
            this.setSelectedGame(_.find(games, (o) => o === $('#change-game-input').val()))
            this.update(this.cachedData, _.find(games, (o) => o === $('#change-game-input').val()))
          } else {
            this.group.children('input').removeClass().addClass('form-control is-invalid')
            $('#change-game-search-list').empty()
            _.each(games, function (game) {
              $('#change-game-search-list').append('<li onclick="changeGT.setGameInput(this)" data-game="' +
                game + '">' + game.replace(new RegExp('(' + $('#change-game-input').val() + ')', 'gi'),
                  "<strong>$1</strong>") + '</li>')
            })
          }
        } else {
          this.group.children('input').removeClass().addClass('form-control is-invalid')
        }
      },
      checkEmptyTitle: function (el) {
        // only if title input radio is selected
        if ($(el).val().trim().length > 0) {
          $(el).removeClass().addClass('form-control is-valid')
        } else {
          $(el).removeClass().addClass('form-control is-invalid')
        }
      },

      gameSelect: function (el) {
        // unfocus every img
        _.each($('.carousel-games-inner').children('div').children('span'), function (unfocus) {
          $(unfocus).removeClass()
          $(unfocus).addClass('col-md-2-auto titles-list-item')
        })
        $(el).parent().addClass('focus')
        this.setSelectedGame(el.dataset.game)
      },
      setSelectedGame: function (game) {
        this.selectedGame = game
        $("#titleForGame").text(translations['for'] + ' ' + game)

        // also, we want to update radios
        this.updateRadios()
      },

      update: function (data, curGame = null) {
        if (_.isArray(data)) data = _.groupBy(data, 'game') // remap array to object if needed
        this.cachedData = data
        curGame = _.isNull(curGame) ? $('#game').text() : curGame

        $('.carousel-games-inner').empty()
        var divItem = $('<div class="carousel-item active">')

        if (curGame !== translations['not-available'] && curGame !== '') {
          var div = $('<span class="" style="cursor: pointer">')
            .addClass('col-md-2-auto focus titles-list-item')
          var img = $('<img>')
          img.attr('src', 'https://static-cdn.jtvnw.net/ttv-boxart/' + encodeURIComponent(curGame) +
            '-100x140.jpg')
          img.attr('onclick', 'changeGT.gameSelect(this)')
          img.attr('title', curGame)
          img.attr('data-game', curGame)
          img.attr('data-deletable', false)
          img.attr('class', 'titles-list-image')
          div.append(img)
          divItem.append(div)
          this.setSelectedGame(curGame)
        }

        var count = (curGame !== translations['not-available'] && curGame !== '') ? 1 : 0
        _.each(data, function (aTitles, aGame) {
          if (aGame === curGame) return // current game is already in carousel

          if (count === 6) { // if 6 elements exists, flush data
            $('.carousel-games-inner').append(divItem)
            divItem = $('<div class="carousel-item">')
            count = 0
          }
          var div = $('<span style="cursor: pointer">')
            .addClass('col-md-2-auto titles-list-item')
          var img = $('<img>')
          img.attr('src', 'https://static-cdn.jtvnw.net/ttv-boxart/' + encodeURIComponent(aGame) +
            '-100x140.jpg')
          img.attr('onclick', 'changeGT.gameSelect(this)')
          img.attr('title', aGame)
          img.attr('data-game', aGame)
          img.attr('class', 'titles-list-image')

          div.append(img)
          divItem.append(div)

          count += 1
        })
        // flush remaining data
        $('.carousel-games-inner').append(divItem)
        // refresh carousel
        $('#carousel-games').carousel()
        // refresh dropdown
        var menu = new BootstrapMenu(".titles-list-image", {
          fetchElementData: function ($el) {
            return $el.data();
          },
          actions: [{
            name: 'Delete',
            iconClass: 'fa-trash-alt',
            onClick: function (game) {
              console.debug('EMIT [deleteUserTwitchGame]', game.game)
              socket.emit('deleteUserTwitchGame', game.game)
            },
            isEnabled: function (game) {
              return game.deletable;
            }
          }]
        })
      },
      updateRadios: function () {
        var self = this
        $('#titles-list').empty()
        var curTitle = !_.isNil(cachedRawTitle) && useRaw ? cachedRawTitle : $('#title').text()

        // all
        var row = $('<div>').addClass('row')

        if (_.isNil(this.cachedData[this.selectedGame])) this.cachedData[this.selectedGame] = []
        if (curTitle !== translations['not-available'] && curTitle !== '') {
          this.selectedTitle = curTitle
          let col = $('<div>').addClass('col-12')
          let inputGroup = $('<div>').addClass('input-group')
            .data('title', this.selectedTitle)
            .data('game', this.selectedGame)
            .on('click', (ev) => {
              // remove checks on all radios
              $('#titles-list input[type=radio]').attr('checked', false)

              //check current radio
              $(ev.currentTarget).children('span').children('span').children('input[type=radio]').attr('checked', true)
              this.selectedTitle = $(ev.currentTarget).data('title')
            })
          let inputGroupPrepend = $('<span>').addClass('input-group-prepend')
          let inputGroupText = $('<span>').addClass('input-group-text')
          let radio = $('<input>')
            .attr('type', 'radio')
            .attr('checked', 'checked')
            .attr('name', 'title')

          let input = $('<input>')
            .attr('type', 'text')
            .attr('disabled', 'disabled')
            .addClass("form-control")
            .val(curTitle)

          inputGroupPrepend.append(inputGroupText.append(radio))
          inputGroup.append(inputGroupPrepend)
          inputGroup.append(input)
          col.append(inputGroup)

          row.append(col)
          $('#titles-list').append(row)
        }

        // items
        for (let item of this.cachedData[this.selectedGame]) {
          let col = $('<div>').addClass('col-12')
          let inputGroup = $('<div>').addClass('input-group')
          let inputGroupPrepend = $('<span>').addClass('input-group-prepend')
          let inputGroupText = $('<span>').addClass('input-group-text')
          let inputGroupTextRight = $('<span>').addClass('input-group-text')
          let radio = $('<input>').attr('type', 'radio').attr('name', 'title')
            .data('title', item.title)
            .data('game', this.selectedGame)
            .on('click', (ev) => {
              // remove checks on all radios
              $('#titles-list input[type=radio]').attr('checked', false)

              //check current radio
              $(ev.currentTarget).attr('checked', true)
              this.selectedTitle = $(ev.currentTarget).data('title')
            })
          let inputGroupAppendRight = $('<span>')
            .addClass('input-group-append')
            .data('title', item.title)
            .data('game', this.selectedGame)
            .on('click', (ev) => {
              console.group('Title delete event')
              console.debug('Game:', $(ev.currentTarget).data('game'))
              console.debug('Original title:', $(ev.currentTarget).data('title'))
              console.groupEnd()
              socket.emit('deleteUserTwitchTitle', {
                game: $(ev.currentTarget).data('game'),
                title: $(ev.currentTarget).data('title')
              })
            })
          let deleteBtn = $('<i>').addClass('far fa-trash-alt')
          let input = $('<input>')
            .attr('type', 'text')
            .addClass("form-control")
            .val(item.title)
            .data('title', item.title)
            .data('game', this.selectedGame)
            .on('click', (ev) => {
              // remove checks on all radios
              $('#titles-list input[type=radio]').attr('checked', false)
              this.selectedTitle = $(ev.currentTarget).val()

              // set check on current radio
              $(ev.currentTarget).parent().children('span').children('span').children('input[type=radio]').attr('checked', true)
            })
            .on('change', (ev) => {
              console.group('Title change event')
              console.debug('Game:', $(ev.currentTarget).data('game'))
              console.debug('Original title:', $(ev.currentTarget).data('title'))
              console.debug('New title:', $(ev.currentTarget).val())
              console.groupEnd()

              socket.emit('editUserTwitchTitle', {
                game: $(ev.currentTarget).data('game'),
                title: $(ev.currentTarget).data('title'),
                new: $(ev.currentTarget).val()
              })

              $(ev.currentTarget).data('title', $(ev.currentTarget).val())
              this.selectedTitle = $(ev.currentTarget).val()
            })

          inputGroupPrepend.append(inputGroupText.append(radio))
          inputGroupAppendRight.append(inputGroupTextRight.append(deleteBtn))

          inputGroup.append(inputGroupPrepend)
          inputGroup.append(input)
          inputGroup.append(inputGroupAppendRight)
          col.append(inputGroup)

          row.append(col)
          $('#titles-list').append(row)
        }

        let col = $('<div>').addClass('col-12')
        let inputGroup = $('<div>').addClass('input-group')
        let inputGroupPrepend = $('<span>').addClass('input-group-prepend')
        let inputGroupText = $('<span>').addClass('input-group-text')
        let radio = $('<input>').attr('type', 'radio').attr('name', 'title')
        let input = $('<input>').attr('type', 'text').addClass("form-control").attr('id', 'change-title').attr('placeholder', commons.translate('create-and-use-a-new-title'))
          .on('click', function (ev) {
            changeGT.checkEmptyTitle(this)

            // remove checks on all radios
            $('#titles-list input[type=radio]').attr('checked', false)

            // set check on current radio
            $(ev.currentTarget).parent().children('span').children('span').children('input[type=radio]').attr('checked', true)
          })
          .on('keyup', function (ev) {
            changeGT.checkEmptyTitle(this)
          })

        inputGroupPrepend.append(inputGroupText.append(radio))
        inputGroup.append(inputGroupPrepend)
        inputGroup.append(input)
        col.append(inputGroup)

        row.append(col)
        $('#titles-list').append(row)
      },
      showDlg: function () {
        $("#title-error").css('display', 'none')

        $("#change-game-input").val('')
        $("#change-title").val('')
        $('#game_and_title_dlg').modal();
        console.debug('EMIT [getUserTwitchGames]')
        socket.emit('getUserTwitchGames')
      },
      save: function () {
        let value = $("#change-title").val()
        let invalid = $("#change-title").hasClass('is-invalid')
        let checked = $("#change-title").parent().children('span').children('span').children('input[type=radio').prop('checked')

        if (invalid && checked) {
          $("#title-error").css('display', 'inline-block')
          return
        } else if (checked) {
          this.selectedTitle = value
        }
        console.debug('EMIT [updateGameAndTitle]', {
          game: this.selectedGame,
          title: this.selectedTitle
        })
        socket.emit('updateGameAndTitle', {
          game: this.selectedGame,
          title: this.selectedTitle
        })
        $('#game_and_title_dlg').modal('hide')
      }
    }

    var saveHighlight = function () {
      console.debug('EMIT [highlight]')
      highlightsSocket.emit('highlight')

    }
    var switchTheme = function () {
      var btn = $('#theme-btn')
      if (btn.text() === translations['dark']) {
        btn.text(translations['light'])
        $('head').append('<link rel="stylesheet" href="./dist/css/dark.css">')
        console.debug('EMIT [saveConfiguration]', {
          'theme': 'dark'
        })
        socket.emit('saveConfiguration', {
          'theme': 'dark'
        })
      } else {
        btn.text(translations['dark'])
        $("LINK[href='./dist/css/dark.css']").remove();
        console.debug('EMIT [saveConfiguration]', {
          'theme': 'light'
        })
        socket.emit('saveConfiguration', {
          'theme': 'light'
        })
      }
    }

    var switchStats = function () {
      var btn = $('#stats-btn')
      var container = $('.stream-info-container')

      btn.data('show-stats', _.isString(btn.data('show-stats')) ? true : btn.data('show-stats'))

      if (btn.data('show-stats')) {
        container.css('display', 'none')
        btn.children('i').removeClass().addClass('far fa-square')
      } else {
        container.css('display', 'block')
        btn.children('i').removeClass().addClass('far fa-check-square')
      }

      btn.data('show-stats', !btn.data('show-stats'))
    }

    var switchMute = function (update = true) {
      var btn = $('#mute-btn')
      btn.data('muted', _.isString(btn.data('muted')) ? true : btn.data('muted'))

      if (btn.data('muted')) {
        btn.children('i').removeClass().addClass('far fa-square')
      } else {
        btn.children('i').removeClass().addClass('far fa-check-square')
      }

      btn.data('muted', !btn.data('muted'))

      if (update) {
        console.debug('EMIT [saveConfiguration]', {
          'mute': btn.data('muted')
        })
        socket.emit('saveConfiguration', {
          'mute': btn.data('muted')
        })
      }
    }

    var switchPercentageShow = function (update = true) {
      var btn = $('#percentage-btn')
      btn.data('showPercentage', _.isString(btn.data('showPercentage')) ? true : btn.data('showPercentage'))

      if (btn.data('showPercentage')) {
        btn.children('i').removeClass().addClass('far fa-square')
      } else {
        btn.children('i').removeClass().addClass('far fa-check-square')
      }

      btn.data('showPercentage', !btn.data('showPercentage'))
      quickStatsApp.b_percentage = btn.data('showPercentage')

      if (update) {
        console.debug('EMIT [saveConfiguration]', {
          'percentage': btn.data('showPercentage')
        })
        socket.emit('saveConfiguration', {
          'percentage': btn.data('showPercentage')
        })
      }
    }

    var switchShowDiff = function (update = true) {
      var btn = $('#showdiff-btn')
      btn.data('switchShowDiff', _.isString(btn.data('switchShowDiff')) ? true : btn.data('switchShowDiff'))

      if (btn.data('switchShowDiff')) {
        btn.children('i').removeClass().addClass('far fa-square')
      } else {
        btn.children('i').removeClass().addClass('far fa-check-square')
      }

      btn.data('switchShowDiff', !btn.data('switchShowDiff'))
      quickStatsApp.b_showAvgDiff = btn.data('switchShowDiff')

      if (update) {
        console.debug('EMIT [saveConfiguration]', {
          'showdiff': btn.data('switchShowDiff')
        })
        socket.emit('saveConfiguration', {
          'showdiff': btn.data('switchShowDiff')
        })
      }
    }

    var switchShortenNumbers = function (update = true) {
      var btn = $('#shortennumber-btn')
      btn.data('switchShortenNumbers', _.isString(btn.data('switchShortenNumbers')) ? true : btn.data('switchShortenNumbers'))

      if (btn.data('switchShortenNumbers')) {
        btn.children('i').removeClass().addClass('far fa-square')
      } else {
        btn.children('i').removeClass().addClass('far fa-check-square')
      }

      btn.data('switchShortenNumbers', !btn.data('switchShortenNumbers'))
      quickStatsApp.b_shortenNumber = btn.data('switchShortenNumbers')

      if (update) {
        console.debug('EMIT [saveConfiguration]', {
          'shortennumbers': btn.data('switchShortenNumbers')
        })
        socket.emit('saveConfiguration', {
          'shortennumbers': btn.data('switchShortenNumbers')
        })
      }
    }

    var switchSticky = function (update = true) {
      var btn = $('#sticky-btn')
      btn.data('switchSticky', _.isString(btn.data('switchSticky')) ? true : btn.data('switchSticky'))

      if (btn.data('switchSticky')) {
        btn.children('i').removeClass().addClass('far fa-square')
      } else {
        btn.children('i').removeClass().addClass('far fa-check-square')
      }

      btn.data('switchSticky', !btn.data('switchSticky'))

      if (btn.data('switchSticky')) {
        $('#quickStatsApp').addClass('sticky-top')
        $('#quickStatsApp').css('top', '50px')
      } else $('#quickStatsApp').removeClass('sticky-top')

      if (update) {
        console.debug('EMIT [saveConfiguration]', {
          'stickystats': btn.data('switchSticky')
        })
        socket.emit('saveConfiguration', {
          'stickystats': btn.data('switchSticky')
        })
      }
    }

    var switchMe = function (update = true) {
      var btn = $('#me-btn')
      btn.data('sendWithMe', _.isString(btn.data('sendWithMe')) ? true : btn.data('sendWithMe'))

      if (btn.data('sendWithMe')) {
        btn.children('i').removeClass().addClass('far fa-square')
      } else {
        btn.children('i').removeClass().addClass('far fa-check-square')
      }

      btn.data('sendWithMe', !btn.data('sendWithMe'))

      if (update) {
        console.debug('EMIT [saveConfiguration]', {
          'sendWithMe': btn.data('sendWithMe')
        })
        socket.emit('saveConfiguration', {
          'sendWithMe': btn.data('sendWithMe')
        })
      }
    }

    var useRaw = false
    var cachedTitle = null
    var cachedRawTitle = null

    var loadCustomVariableValue = async function (variable) {
      return new Promise((resolve, reject) => {
        socket.emit('custom.variable.value', variable, (err, value) => {
          resolve(value)
        })
      })
    }

    var generateTitle = async function (current, raw) {
      if (raw.length === 0) return current
      cachedRawTitle = raw

      let variables = raw.match(/(\$_[a-zA-Z0-9_]+)/g)
      if (cachedTitle === current && _.isNil(variables)) return cachedTitle

      if (!_.isNil(variables)) {
        for (let variable of variables) {
          useRaw = true
          let value = await loadCustomVariableValue(variable)
          raw = raw.replace(variable, `<strong style="border-bottom: 1px dotted gray" data-toggle="tooltip" data-placement="bottom" title="${variable}">${value}</strong>`)
        }
      }
      cachedTitle = raw
      return raw
    }

    var setStatus = function (id, status) {
      $("#" + id + "Status").data('status', status)

      $("#" + id + "Status").removeClass()

      if (id === 'SOC' && status === 0) {
        $("[id$='Status']").removeClass()
        $("[id$='Status']").addClass('alert alert-muted')
      }

      if (id === 'RES') {
        $("#" + id + "Status").attr('title', 'Average bot response ' + status + 'ms')
        if (status >= 1500) {
          $("#" + id + "Status").addClass('alert alert-danger')
        } else if (status < 1500 && status >= 800) {
          $("#" + id + "Status").addClass('alert alert-warning')
        } else {
          $("#" + id + "Status").addClass('alert alert-success')
        }
        $("#" + id + "Status").text(status + 'ms')
        $("#" + id + "Status").css('padding', '0')
      }

      if (id === 'MOD') {
        $("#" + id + "Status").attr('title', 'Bot is' + (status ? ' ' : ' not ') + 'a MOD')
        $("#" + id + "Status").addClass('alert alert-' + (status ? 'success' : 'danger'))
        $("#" + id + "Status").css('padding', '0')
        return
      }

      switch (status) {
        case 0:
          $("#" + id + "Status").attr('title', id + ' disconnected')
          $("#" + id + "Status").addClass('alert alert-danger')
          break;
        case 1:
          $("#" + id + "Status").attr('title', id + ' connecting')
          $("#" + id + "Status").addClass('alert alert-warning')
          break;
        case 2:
          $("#" + id + "Status").attr('title', id + ' reconnecting')
          $("#" + id + "Status").addClass('alert alert-warning')
        case 3:
          $("#" + id + "Status").attr('title', id + ' connected')
          $("#" + id + "Status").addClass('alert alert-success')
          break;
      }
      $("#" + id + "Status").css('padding', '0')
    }

   // dont save as html anywhere on contenteditables
   $(document).on("paste","[contenteditable=true]", function(e) {
    var text = '';
    var that = $(this);

    if (e.clipboardData)
        text = e.clipboardData.getData('text/plain');
    else if (window.clipboardData)
        text = window.clipboardData.getData('Text');
    else if (e.originalEvent.clipboardData)
        text = $('<div></div>').text(e.originalEvent.clipboardData.getData('text'));

    if (document.queryCommandSupported('insertText')) {
        document.execCommand('insertHTML', false, $(text).html());
        return false;
    }
    else { // IE > 7
      that.find('*').each(function () {
            $(this).addClass('within');
      });

      setTimeout(function () {
            // nochmal alle durchlaufen
            that.find('*').each(function () {
                  // wenn das element keine klasse 'within' hat, dann unwrap
                  // http://api.jquery.com/unwrap/
                  $(this).not('.within').contents().unwrap();
            });
      }, 1);
    }
    })

    function joinBot() {
      socket.emit('joinBot')
    }

    function leaveBot() {
      socket.emit('leaveBot')
    }

    $(document).on('click', '.widget-popout a', (ev) => {
      ev.preventDefault()
      let widget = $(ev.currentTarget).attr('href').split('#')[1]
      window.open($(ev.currentTarget).attr('href'),widget,'height=600,width=600');
    })

    // allow focus on dropdowns with data-allow-focus
    $(document).on("click", "[data-allow-focus]", function(e) {
      e.preventDefault()
      e.stopPropagation();
    });
  </script>
</body>
</html>
